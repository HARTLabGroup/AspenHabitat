---
title: " "
author: " "
email: " "
date: " "
output: 
  bookdown::html_document2:
    code_folding: hide
    toc: TRUE
    toc_depth: 4
    toc_float: TRUE
    collapsed: FALSE
    theme: spacelab
    fig_caption: TRUE
    number_sections: FALSE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = F,
	message = FALSE,
	warning = FALSE,
	dpi = 300,
	progress = FALSE,
	cache = FALSE,
	fig.align="center",
	fig.width=7
)


set.seed(513)
options(repos = c(CRAN = "http://cran.rstudio.com"))
options(timeout=60*30) #timeout downloads that last longer than 30 minutes

if (!require("pacman")) install.packages("pacman")
pacman::p_load(
  here, # easy file structure
  tidyverse, # data manipulation
  tidymodels, 
  reshape, # old data manipulation pkg
  ggplot2, # figures
  patchwork, # multiple figures
  grid, # multiple figures
  ggsci, # color palettes
  colorspace, # color palettes
  RColorBrewer, # color palettes
  knitr, # markdown documents
  kableExtra, # tables in markdown
  flextable, # other table options
  bookdown, # figure numbering in markdown
  sf, # spatial data (new pkg)
  terra, # raster data
  raster, # (old pkg)
  tmap, # easy plotting of maps
  terrainr, # elevation data
  spatialEco, # hli, tpi
  sdm,# species distribution modeling
  rgdal,
  parallel,
  FNN,
  maptools,
  rgeos,
  elevatr
) 

cores <- parallel::detectCores() # Set number of cores for parallel processing

# Set custom plotting theme
theme_new <- function(base_size = 9,base_family = "Helvetica"){
  theme_classic(base_size = base_size, base_family = base_family) %+replace%
    theme(
      axis.line.x = element_line(color="black", size = 0.25),
      axis.line.y = element_line(color="black", size = 0.25),
      axis.title = element_text(size = 9),
      axis.text = element_text(colour="black", size=8),
      legend.key=element_rect(colour=NA, fill =NA),
      panel.grid = element_blank(),   
      plot.background = element_rect(fill = NA, colour = NA),
      panel.border = element_rect(fill = NA, colour = NA),
      panel.background = element_rect(fill = "white", colour = "black"), 
      strip.background = element_rect(fill = "white"),
      strip.text = element_text(size = 9)
      
    )
}
theme_set(theme_new())


# Set directory structure for project
dir.create(here("Data"), showWarnings = FALSE)
dir.create(here("Data", "Spatial"), showWarnings = FALSE)
dir.create(here("Results"), showWarnings = FALSE)
dir.create(here("Results", "Figures"), showWarnings = FALSE)
```

# Objectives:

JFSP Aim 4: Produce maps of current and future aspen habitat suitability

### Proposed methods

To quantify aspen habitat suitability, we will construct statistical models of aspen presence that incorporate historical climate, soil, and topography variables as predictors. We will randomly sample the Sentinel-2 based maps of aspen produced here (Aim 1) to generate 1000 aspen presences and absences within the SRM. To limit the influence of spatial autocorrelation (Veloz 2009), we will filter all the records by a minimum distance of 1 km. For each presence and absence record, we will then characterize the historical climate, topography and soils conditions. We will characterize fine scale variability in incident radiation using the heat load index, which we will calculate from 10 m DEM. To characterize soil characteristics that may influence habitat suitability for aspen, we will use 30 m grids of soil pH and percent clay cover (Chaney et al. 2019). To characterize historical (1981-2015) climate, we will use climate data from gridMet (Abatzoglou 2013). Specifically, we will obtain mean total winter, summer, and annual precipitation and average summer and winter temperatures, which are related to aspen presence (Rehfeldt et al. 2009, Ellenwood et al. 2015). Additionally, we will calculate mean annual actual evapotranspiration (AET) and climatic water deficit (CWD), two integrative measures of the amount of energy and water available for plant growth that are linked to plant species distributions (Stephenson 1990, Lutz et al. 2010). gridMET products are available at a ca. 4 km resolution, a scale that is too coarse to describe topographically controlled climate variation characteristic of mountainous environments (Franklin et al. 2013). To this end, we will downscale climate data to a 250 m resolution using gradient and inverse distance squared (GIDS) interpolation (Nalder and Wein 1998, Flint and Flint 2012), following methods outlined in Rodman et al. (2020)

We will then use an ensemble modeling approach to generate predictions of aspen habit suitability. We will model presence/absence using several machine learning approaches widely used in habitat suitability modeling (e.g. Bayesian Additive Regression Trees Chipman et al. 2010). Individual models will first be tuned using the R package caret (Kuhn 2020) and then we will use cross-validation to estimate the performance of all models and generate ensemble predictions using the R package SuperLearner (Polley et al. 2019). To generate future predictions of aspen habitat suitability, we will incorporate future (2021-2099) climate data generated using the Multivariate Adaptive Constructed Analogs (MACA) method (Abatzoglou and Brown 2012). We will obtain future climate projections under an intermediate pathway (RCP4.5) and a high emissions pathway (RCP8.5) (IPCC 2014). To encompass the variability in global circulation model (GCM) projections, we will select three GCMs that span the range of project change. We will then downscale future climate data to 250 m following the methods described above. Finally, we will use fitted models to make projections of the future of aspen habitat suitability.


# Data
## Download data
### Ecoregions
```{r download ecoregions}
temp <- here("Data", "Spatial", "Ecoregions","us_eco_l3.zip")
if(!file.exists(temp)){
download.file("https://gaftp.epa.gov/EPADataCommons/ORD/Ecoregions/us/us_eco_l3.zip", temp, mode="wb")
unzip(temp, exdir=here("Data", "Spatial", "Ecoregions"))
}
```

### High resolution aspen cover
Cook and Balch (unpublished)
- This code will download a 10 m resolution map of aspen cover for the Southern Rocky Mountain Ecoregion, which extends from southern Wyoming to northern New Mexico. The map represents aspen cover in ca. 2019 and was produced from Sentinel imagery (JFSP AIM 1)
Updated aspen data with 0.64 probability

```{r}
dir.create(here("Data", "Spatial", "Aspen"), showWarnings = FALSE)
temp <- here("Data", "Spatial", "Aspen", "SRM_ASPEN_CLASSIFIED_RF_10M_V1_0223.tif", mode="wb")
if(!file.exists(temp)){
download.file("https://1drv.ms/u/s!Aq4s9rj0qHBilL4B4PH1amvdUoiLyg?e=jHRUWI", temp )
}
```


### Soils
```{r}
if(!file.exists(here("Data","Spatial", "Soils"))){
  dir.create(here("Data","Spatial", "Soils"), showWarnings = FALSE)

  #SRM %>% st_transform(crs=4326) %>% st_bbox --> lat: 35-43; lon:103-110
  lons <- c("110-109", "109-108", "108-107", "107-106", "106-105", "105-104", "104-103")
  lats <- c("3536", "3637", "3738", "3839","3940", "4041", "4142", "4243")

  # download mean pH of top 5-15 cm
  for(j in lons){
    for(k in lats){
      temp <- paste0(here("Data","Spatial", "Soils", "lat"), k,"_lon-", j, "_meanPh_5_15.tif")
      download.file(paste0("http://hydrology.cee.duke.edu/POLARIS/PROPERTIES/v1.0/ph/mean/5_15/lat",   k, "_lon-", j, ".tif"), temp, mode="wb")
    }
  }
  
  # Merge mean pH files
  ph.files <- list.files(path=here("Data","Spatial", "Soils"), pattern="meanPh_5_15.tif", full.names=T)
  ph.rast <- lapply(ph.files,FUN=rast)
  ph.rast <- sprc(ph.rast)
  ph.merge <- merge(ph.rast, first=T)
  writeRaster(ph.merge, here("Data","Spatial", "Soils", "meanPh_5_15-SRM.tif"))
  
  # download mean percent clay of top 5-15 cm
  for(j in lons){
    for(k in lats){
      temp <- paste0(here("Data","Spatial", "Soils", "lat"), k,"_lon-", j, "_meanClay_5_15.tif")
      download.file(paste0("http://hydrology.cee.duke.edu/POLARIS/PROPERTIES/v1.0/clay/mean/5_15/lat"  , k, "_lon-", j, ".tif"), temp, mode="wb")
    }
  }
  
  # Merge mean clay files
  clay.files <- list.files(path=here("Data", "Spatial", "Soils"), pattern="meanClay_5_15.tif",   full.names=T)
  clay.rast <- lapply(clay.files,FUN=rast)
  clay.rast <- sprc(clay.rast)
  clay.merge <- merge(clay.rast, first=T)
  writeRaster(clay.merge, here("Data", "Spatial", "Soils", "meanClay_5_15-SRM.tif"))
}
### download mean percent theta_s (saturated soil water content) of top 5-15 cm
  for(j in lons){
    for(k in lats){
      temp <- paste0(here("Data","Spatial", "Soils", "lat"), k,"_lon-", j, "_meantheta_s_5_15.tif")
      download.file(paste0("http://hydrology.cee.duke.edu/POLARIS/PROPERTIES/v1.0/theta_s/mean/5_15/lat"  , k, "_lon-", j, ".tif"), temp, mode="wb")
    }
  }
  
  # Merge theta_s files
  theta_s.files <- list.files(path=here("Data", "Spatial", "Soils"), pattern="meantheta_s_5_15.tif",   full.names=T)
  theta_s.rast <- lapply(theta_s.files,FUN=rast)
  theta_s.rast <- sprc(theta_s.rast)
  theta_s.merge <- merge(theta_s.rast, first=T)
  writeRaster(theta_s.merge, here("Data", "Spatial", "Soils", "meantheta_s_5_15-SRM.tif"))
  
  ##download mean percent om (organic matter) of top 5-15 cm
  for(j in lons){
    for(k in lats){
      temp <- paste0(here("Data","Spatial", "Soils", "lat"), k,"_lon-", j, "_meanom_5_15.tif")
      download.file(paste0("http://hydrology.cee.duke.edu/POLARIS/PROPERTIES/v1.0/om/mean/5_15/lat"  , k, "_lon-", j, ".tif"), temp, mode="wb")
    }
  }
  
 # Merge om files
  om.files <- list.files(path=here("Data", "Spatial", "Soils"), pattern="meanom_5_15.tif",   full.names=T)
  om.rast <- lapply(om.files,FUN=rast)
  om.rast <- sprc(om.rast)
  om.merge <- merge(om.rast, first=T)
  writeRaster(om.merge, here("Data", "Spatial", "Soils", "meanom_5_15-SRM.tif"))  
```

### DEM
```{r}
if(!file.exists(here("Data", "Spatial","DEM"))){
  
  dir.create(here("Data", "Spatial","DEM"), showWarnings = FALSE)
  
  SRM <- st_read(here("Data", "Spatial", "Ecoregions",
"us_eco_l3.shp")) %>% filter(US_L3NAME == 'Southern Rockies') %>% st_transform(crs=5071) %>% st_buffer(20000)

  # 30 m 
  dem <- get_tiles(data=SRM, output_prefix = here("Data", "Spatial", "DEM", "DEM30"), services="elevation",   resolution=30)
dem.rast <- lapply(dem$elevation,FUN=rast)
  for(j in 2:length(dem.rast)){dem.rast[[j]] <-  terra::project(dem.rast[[j]], dem.rast[[1]], align=T)}
  dem.sprc <- sprc(dem.rast)
  dem.mosaic <- mosaic(dem.sprc)
  writeRaster(dem.mosaic, here("Data", "Spatial", "DEM", "DEM30-mosaic.tif"), overwrite=T)
  
  # 250 m 
  dem <- get_tiles(data=SRM, output_prefix = here("Data", "Spatial", "DEM", "DEM250"), services="elevation",   resolution=250)
  dem.rast <- lapply(dem$elevation,FUN=rast)
  writeRaster(dem.rast[[1]], here("Data", "Spatial", "DEM", "DEM250.tif"), overwrite=T)
}
```

### Climate data
#### ClimateNA

```{r}
dir.create(here("Data","Spatial", "Climate"))
if(!file.exists(here("Data","Spatial", "Climate", "ClimateNA"))){
  dir.create(here("Data","Spatial", "Climate", "ClimateNA"), showWarnings = FALSE)
  temp <- here("Data","Spatial", "Climate", "ClimateNA", "Normal_1981_2010_bioclim.zip")
  download.file("https://s3-us-west-2.amazonaws.com/www.cacpd.org/CMIP6v73/normals/Normal_1981_2010_bioclim.zip", temp, mode="wb")
  unzip(temp, exdir=here("Data", "Spatial", "Climate", "CLimateNA"))
  
  ## 2011-2040 Emission Scenario SSP2-4.5
  temp <- here("Data","Spatial", "Climate", "ClimateNA","ensemble_8GCMs_ssp245_2011_2040_bioclim.zip")
  download.file("https://s3-us-west-2.amazonaws.com/www.cacpd.org/CMIP6v73/ensembles/ensemble_8GCMs_ssp245_2011_2040_bioclim.zip", temp, mode="wb")
  unzip(temp, exdir=here("Data", "Spatial", "Climate", "CLimateNA"))
  
  ## 2040-2070 Emission Scenario SSP2-4.5
  temp <- here("Data","Spatial", "Climate", "ClimateNA","ensemble_8GCMs_ssp245_2041_2070_bioclim.zip")
  download.file("https://s3-us-west-2.amazonaws.com/www.cacpd.org/CMIP6v73/ensembles/ensemble_8GCMs_ssp245_2041_2070_bioclim.zip", temp, mode="wb")
  unzip(temp, exdir=here("Data", "Spatial", "Climate", "CLimateNA"))
  
  ## 2071-2100 Emission Scenario SSP2-4.5
  temp <- here("Data","Spatial", "Climate", "ClimateNA","ensemble_8GCMs_ssp245_2071_2100_bioclim.zip")
  download.file("https://s3-us-west-2.amazonaws.com/www.cacpd.org/CMIP6v73/ensembles/ensemble_8GCMs_ssp245_2071_2100_bioclim.zip", temp, mode="wb")
  unzip(temp, exdir=here("Data", "Spatial", "Climate", "CLimateNA"))
 
  ##2011-2040 Emission Scenario SSP5-8.5
  temp <- here("Data","Spatial", "Climate", "ClimateNA","ensemble_8GCMs_ssp585_2011_2040_bioclim.zip")
  download.file("https://s3-us-west-2.amazonaws.com/www.cacpd.org/CMIP6v73/ensembles/ensemble_8GCMs_ssp585_2011_2040_bioclim.zip", temp, mode="wb")
  unzip(temp, exdir=here("Data", "Spatial", "Climate", "CLimateNA"))
 
  ##2041-2070 Emission Scenario SSP5-8.5
  temp <- here("Data","Spatial", "Climate", "ClimateNA","ensemble_8GCMs_ssp585_2041_2070_bioclim.zip")
  download.file("https://s3-us-west-2.amazonaws.com/www.cacpd.org/CMIP6v73/ensembles/ensemble_8GCMs_ssp585_2041_2070_bioclim.zip", temp, mode="wb")
  unzip(temp, exdir=here("Data", "Spatial", "Climate", "CLimateNA"))
  
  ##2071-2100 Emission Scenario SSP5-8.5
  temp <- here("Data","Spatial", "Climate", "ClimateNA","ensemble_8GCMs_ssp585_2071_2100_bioclim.zip")
  download.file("https://s3-us-west-2.amazonaws.com/www.cacpd.org/CMIP6v73/ensembles/ensemble_8GCMs_ssp585_2071_2100_bioclim.zip", temp, mode="wb")
  unzip(temp, exdir=here("Data", "Spatial", "Climate", "CLimateNA"))
}
```

#### TopoFire

```{r}
dir.create(here("Data","Spatial", "Climate"))
if(!file.exists(here("Data","Spatial", "Climate", "TopoFire"))){
  dir.create(here("Data","Spatial", "Climate", "TopoFire"), showWarnings = FALSE)
  temp <- here("Data","Spatial", "Climate", "TopoFire", "aet_1981-2010_mean.tif")
  download.file("https://topofire.dbs.umt.edu/public_data/topofire_weather/normals_old/aet_1981-2010_mean.tif", temp, mode="wb")
  temp <- here("Data","Spatial", "Climate", "TopoFire", "def_1981-2010_mean.tif")
  download.file("https://topofire.dbs.umt.edu/public_data/topofire_weather/normals_old/def_1981-2010_annual_mean.tif", temp, mode="wb")
}
```

## Data processing
### Calculate heat load index
```{r}
if(!file.exists(here("Data","Spatial", "DEM", "DEM30-mosaic-HLI.tif"))){
  dem.mosaic <- rast(here(here("Data","Spatial", "DEM", "DEM30-mosaic.tif")))
  hli.rast <- hli(dem.mosaic, force.hemisphere = "northern")
  writeRaster(hli.rast, here("Data","Spatial", "DEM", "DEM30-mosaic-HLI.tif"))
}
```

### Caculate topographic position index (TPI)
#### 3 cell neighborhood
```{r}
if(!file.exists(here("Data","Spatial", "DEM", "DEM30-mosaic-TPI3.tif"))){
  dem.mosaic <- rast(here(here("Data","Spatial", "DEM", "DEM30-mosaic.tif")))
  tpi.rast <- tpi(dem.mosaic, scale=3)
  writeRaster(tpi.rast, here("Data","Spatial", "DEM", "DEM30-mosaic-TPI3.tif"))
}
```

#### 15 cell neighborhood
```{r}
if(!file.exists(here("Data","Spatial", "DEM", "DEM30-mosaic-TPI15.tif"))){
  dem.mosaic <- rast(here(here("Data","Spatial", "DEM", "DEM30-mosaic.tif")))
  tpi.rast <- tpi(dem.mosaic, scale=15)
  writeRaster(tpi.rast, here("Data","Spatial", "DEM", "DEM30-mosaic-TPI15.tif"))
}
```

## Downscaling


```{r, downscale}
source(here("Code", "GIDS-Downscaling-SJH.R"))

# Set desired projection
proj.proj <- "+proj=utm +zone=13 +ellps=GRS80 +datum=NAD83 +units=m +no_defs"

# Import study area boundary
study.area <- st_read(here("Data", "Spatial", "Ecoregions", "us_eco_l3.shp")) %>% filter(US_L3NAME == 'Southern Rockies') %>% st_transform(crs(proj.proj)) %>% st_buffer(20000)

# Import template for downscaling
template <- rast(here("Data", "Spatial", "DEM", "DEM250.tif"))
template <- template %>% terra::project(proj.proj)
template<- template %>% crop(study.area)
 
# Warning message happens because number of raster cells is not evenly divisible
# by number of cores on PC

select.climate.variables <-c("CMD", "DD_0", "DD5", "MAP", "MCMT", "MSP", "MWMT", "RH", "SHM", "TD","Tmax")
dir.create(here("Data", "Spatial", "Downscaled"), showWarnings = FALSE)
for(j in select.climate.variables){
  if(!file.exists(paste0(here("Data", "Spatial", "Downscaled", "ensemble_8GCMs_ssp245_2011_2040_"), j, "-downscaled.tif"))){
    ptm <- proc.time()
    clim <- rast(paste0(here("Data", "Spatial", "Climate", "CLimateNA", "ensemble_8GCMs_ssp245_2011_2040", "ensemble_8GCMs_ssp245_2011_2040_bioclim", "ensemble_8GCMs_ssp245_2011_2040_"), j, ".tif"))
    clim <- clim %>% terra::project(proj.proj)
    clim <- clim %>% crop(study.area)
  
    if(j ==select.climate.variables[1]){template_coarse <- terra::project(template ,clim, method="bilinear")}   ## Creating second DEM at same resolution as climate grid; only do this for the first iteration
    
    ds_layer <- multiLevelInterpParrallel(boundary = study.area, ds_layer = clim,
                                        ancillary_list = list(template_coarse, template), 
                                        clip_dists = c(20000, 5000, 500))
  
    writeRaster(ds_layer, paste0(here("Data", "Spatial", "Downscaled", "ensemble_8GCMs_ssp245_2011_2040_"), j, "-downscaled.tif"))
    rm(ds_layer) # remove 
    gc() # clean up garbage (sometimes this helps)
    print(j) # print j so we know how far along our code is
    time <- proc.time() - ptm
    print(time[3]/60) # print time for each iteration 
  }

}

for(j in select.climate.variables){
  if(!file.exists(paste0(here("Data", "Spatial", "Downscaled", "ensemble_8GCMs_ssp245_2041_2070_"), j, "-downscaled.tif"))){

    ptm <- proc.time()
    clim <- rast(paste0(here("Data", "Spatial", "Climate", "CLimateNA", "ensemble_8GCMs_ssp245_2041_2070", "ensemble_8GCMs_ssp245_2041_2070_bioclim", "ensemble_8GCMs_ssp245_2041_2070_"), j, ".tif"))
    clim <- clim %>% terra::project(proj.proj)
    clim <- clim %>% crop(study.area)
  
    if(j ==select.climate.variables[1]){template_coarse <- terra::project(template,clim, method="bilinear")}   ## Creating second DEM at same resolution as climate grid; only do this for the first iteration
    
    ds_layer <- multiLevelInterpParrallel(boundary = study.area, ds_layer = clim,
                                        ancillary_list = list(template_coarse, template), 
                                        clip_dists = c(20000, 5000, 500))
    writeRaster(ds_layer, paste0(here("Data", "Spatial", "Downscaled", "ensemble_8GCMs_ssp245_2041_2070_"), j, "-downscaled.tif"))
    rm(ds_layer) # remove 
    gc() # clean up garbage (sometimes this helps)
    print(j) # print j so we know how far along our code is
    time <- proc.time() - ptm
    print(time[3]/60) # print time for each iteration
  }
}

for(j in select.climate.variables){
  if(!file.exists(paste0(here("Data", "Spatial", "Downscaled", "ensemble_8GCMs_ssp245_2071_2100_"), j, "-downscaled.tif"))){

    ptm <- proc.time()
    clim <- rast(paste0(here("Data", "Spatial", "Climate", "CLimateNA", "ensemble_8GCMs_ssp245_2071_2100", "ensemble_8GCMs_ssp245_2071_2100_bioclim", "ensemble_8GCMs_ssp245_2071_2100_"), j, ".tif"))
    clim <- clim %>% terra::project("+proj=utm +zone=13 +ellps=GRS80 +datum=NAD83 +units=m +no_defs")
    clim <- clim %>% crop(study.area)
    
    if(j ==select.climate.variables[1]){template_coarse <- terra::project(template,clim, method="bilinear")}   ## Creating second DEM at same resolution as climate grid; only do this for the first iteration
    
    ds_layer <- multiLevelInterpParrallel(boundary = study.area, ds_layer = clim,
                                        ancillary_list = list(template_coarse, template), 
                                        clip_dists = c(20000, 5000, 500))
    writeRaster(ds_layer, paste0(here("Data", "Spatial", "Downscaled", "ensemble_8GCMs_ssp245_2071_2100_"), j, "-downscaled.tif"))
    rm(ds_layer) # remove 
    gc() # clean up garbage (sometimes this helps)
    print(j) # print j so we know how far along our code is
    time <- proc.time() - ptm
    print(time[3]/60) # print time for each iteration 
  }
}
```


## Analyses
#### Import data
```{r}
# RESAMPLE 
aspen <- rast(here("Data", "Spatial", "Aspen", "SRM_ASPEN_CLASSIFIED_RF_10M_V1_0522.tif"))
tpi3 <- rast(here("Data", "Spatial", "DEM", "DEM30-mosaic-TPI3.tif")) 
tpi15 <- rast(here("Data", "Spatial", "DEM", "DEM30-mosaic-TPI15.tif"))
hli <- rast(here("Data", "Spatial", "DEM", "DEM30-mosaic-HLI.tif"))
topo <- c(tpi3, tpi15, hli) %>% project(crs(aspen))
names(topo) <- c("tpi3", "tpi15", "hli")
if(!file.exists(filename=here("Data", "Spatial", "DEM", "Topo10.tif"))){
  topo.re <- resample(topo, aspen, method="near", threads=T, filename=here("Data", "Spatial", "DEM", "Topo10.tif"),overwrite=TRUE)
}
ph <- rast(here("Data", "Spatial", "Soils", "meanPh_0_5-SRM.tif"))  %>% project(crs(aspen))
clay <- rast(here("Data", "Spatial", "Soils", "meanClay_0_5-SRM.tif"))  %>% project(crs(aspen))
soil <- c(ph, clay)
names(soil) <- c("pH", "clay")
soil.re <- resample(soil, aspen, method="near", threads=T, filename=here("Data", "Spatial", "Soils", "Topo10.tif"),overwrite=TRUE)

climate <- list.files(here("Data", "Spatial", "Downscaled"), pattern="Normal", full.names=T)
climate <- rast(climate) %>% project(crs(aspen))
names(climate) <- sapply(sapply(sapply(sapply(list.files(here("Data", "Spatial", "Downscaled"), pattern="Normal", full.names=T), strsplit, split="2010_"), "[", 2), strsplit, split="-downscaled.tif"), "[", 1)
climate.re <- resample(climate, aspen, method="near", threads=T, filename=here("Data", "Spatial", "Downscaled", "Climate10.tif"),overwrite=TRUE)

predictors <- c(climate.re, soil.re, topo.re)
```

#random sampling of Aspen presence and absence
#Correlation matrix and predictor variable selection
#BioMod2
```{r}
library(biomod2)
library(raster)
library(rasterVis)
library(ggplot2)
library(gridExtra)
#Heat Load Index

#Stacking soil and climate data
setwd("D:/BioMod2Try/0_Data_final/current")
rlist=list.files(pattern="tif$",full.names = TRUE)
s_xvar=stack(rlist)
names(s_xvar)
```

