---
title: " "
author: " "
email: " "
date: " "
output: 
  bookdown::html_document2:
    code_folding: hide
    toc: TRUE
    toc_depth: 4
    toc_float: TRUE
    collapsed: FALSE
    theme: spacelab
    fig_caption: TRUE
    number_sections: FALSE
bibliography: references.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = F,
	message = FALSE,
	warning = FALSE,
	dpi = 300,
	progress = FALSE,
	cache = FALSE,
	fig.align="center",
	fig.width=7
)


set.seed(513)
options(repos = c(CRAN = "http://cran.rstudio.com"))
options(timeout=60*30) #timeout downloads that last longer than 30 minutes

if (!require("pacman")) install.packages("pacman")
pacman::p_load(
  knitr, # markdown documents
  flextable, # plot tables
  bookdown, # figure numbering in markdown
  here, # easy file structure
  tidyverse, # data manipulation
  ggplot2, # figures
  patchwork, # multiple figures
  grid, # multiple figures
  gridExtra,
  ggsci, # color palettes
  colorspace, # color palettes
  RColorBrewer, # color palettes
  ggcorrplot, # plot correlation between variables
  sf, # spatial data (new pkg)
  terra, # raster data
  rgdal,
  raster, # (old pkg)
  rasterVis,
  tidyterra, #tidyverse extension to spatial data
  tmap, # easy plotting of maps
  terrainr, # elevation data
  spatialEco, # hli, tpi
  parallel,
  FNN,
  maptools,
  rgeos,
  elevatr, 
  tidymodels,
  vip,
  pROC,
  DALEXtra
) 

cores <- parallel::detectCores() # Set number of cores for parallel processing

# Set custom plotting theme
theme_new <- function(base_size = 9,base_family = "Helvetica"){
  theme_classic(base_size = base_size, base_family = base_family) %+replace%
    theme(
      axis.line.x = element_line(color="black", linewidth = 0.25),
      axis.line.y = element_line(color="black", linewidth = 0.25),
      axis.title = element_text(size = 9),
      axis.text = element_text(colour="black", size=8),
      legend.key=element_rect(colour=NA, fill =NA),
      panel.grid = element_blank(),   
      plot.background = element_rect(fill = NA, colour = NA),
      panel.border = element_rect(fill = NA, colour = NA),
      panel.background = element_rect(fill = "white", colour = "black"), 
      strip.background = element_rect(fill = "white"),
      strip.text = element_text(size = 9)
      
    )
}
theme_set(theme_new())


# Set directory structure for project
dir.create(here("Data"), showWarnings = FALSE)
dir.create(here("Data", "Spatial"), showWarnings = FALSE)
dir.create(here("Results"), showWarnings = FALSE)
dir.create(here("Results", "Figures"), showWarnings = FALSE)
```

# Introduction

Most species distribution modeling relies upon records of observations of species occurrence, which are often spatially biased.

Species distribution models of tree species often make use of \# Methods

## Study area

Our study area consists of the Southern Rocky Mountains Ecoregion (SRME), an area of approximately 145,700 km2 that extends from southern Wyoming to northern New Mexico (FIGURE).  The SRME region consists of mountainous topography with elevation ranging from 1125 m asl to above 4389 m asl.

[Climate]

[Forests]

```{r DL_ecoregions}
temp <- here("Data", "Spatial", "Ecoregions","us_eco_l3.zip")
if(!file.exists(temp)){
download.file("https://gaftp.epa.gov/EPADataCommons/ORD/Ecoregions/us/us_eco_l3.zip", temp, mode="wb")
unzip(temp, exdir=here("Data", "Spatial", "Ecoregions"))
}
```

## Species occurrence data

Our species presence data are derived from Cook et al. (in prep), which is based on high resolution (10 m) imagery analysis collected from Sentinel-2 on and photo interpretation of aspen presence from year 2018. Of the more than 98 million pixels  with aspen present, we randomly selected 1,000 pixels. To minimize the potential effects of spatial autocorrelation all samples were separated by a distance of at least 1 kilometer. We also did the same process to randomly select 1000 aspen absence pixels.

```{r DL_aspen}
dir.create(here("Data", "Spatial", "Aspen"), showWarnings = FALSE)
temp <- here("Data", "Spatial", "Aspen", "SRM_ASPEN_CLASSIFIED_RF_10M_V1_0223.tif", mode="wb")
if(!file.exists(temp)){
download.file("https://1drv.ms/u/s!Aq4s9rj0qHBilL4B4PH1amvdUoiLyg?e=jHRUWI", temp )
}
```

## Predictor variables

#### Soils

We also included soil properties in our models of aspen habitat suitability. Specifically, we obtained 30-m probabilistic maps of soil properties, including soil pH, percentage of clay, and saturated soil water content from the POLARIS database [@chaney2019] . These soil variables were further resampled to match with resolution of climate data upscaling to 250 m. As mentioned in Alban, 1982; Goebes et al., 2019; Ste-Marie et al., 2007;  and Woldeselassie et al., 2012, we considered soil variables from the depth of 5-15 cm that lies within the critical depth range (0-20 cm) in determining the soil edaphic conditions. Therefore, within this range of depth, soil properties are found to influence overstory and understory vegetation including aspen.

```{r DL_soils}
#SRM %>% st_transform(crs=4326) %>% st_bbox --> lat: 35-43; lon:103-110 
lons <- c("110-109", "109-108", "108-107", "107-106", "106-105", "105-104", "104-103")
lats <- c("3536", "3637", "3738", "3839","3940", "4041", "4142", "4243")

if(!file.exists(here("Data","Spatial", "Soils"))){
  dir.create(here("Data","Spatial", "Soils"), showWarnings = FALSE)

 
  # download mean pH of top 5-15 cm
  for(j in lons){
    for(k in lats){
      temp <- paste0(here("Data","Spatial", "Soils", "lat"), k,"_lon-", j, "_meanPh_5_15.tif")
      download.file(paste0("http://hydrology.cee.duke.edu/POLARIS/PROPERTIES/v1.0/ph/mean/5_15/lat",   k, "_lon-", j, ".tif"), temp, mode="wb")
    }
  }
  
  # Merge mean pH files
  ph.files <- list.files(path=here("Data","Spatial", "Soils"), pattern="meanPh_5_15.tif", full.names=T)
  ph.rast <- lapply(ph.files,FUN=rast)
  ph.rast <- sprc(ph.rast)
  ph.merge <- merge(ph.rast, first=T)
  writeRaster(ph.merge, here("Data","Spatial", "Soils", "meanPh_5_15-SRM.tif"))
  
  # download mean percent clay of top 5-15 cm
  for(j in lons){
    for(k in lats){
      temp <- paste0(here("Data","Spatial", "Soils", "lat"), k,"_lon-", j, "_meanClay_5_15.tif")
      download.file(paste0("http://hydrology.cee.duke.edu/POLARIS/PROPERTIES/v1.0/clay/mean/5_15/lat"  , k, "_lon-", j, ".tif"), temp, mode="wb")
    }
  }
  
  # Merge mean clay files
  clay.files <- list.files(path=here("Data", "Spatial", "Soils"), pattern="meanClay_5_15.tif",   full.names=T)
  clay.rast <- lapply(clay.files,FUN=rast)
  clay.rast <- sprc(clay.rast)
  clay.merge <- merge(clay.rast, first=T)
  writeRaster(clay.merge, here("Data", "Spatial", "Soils", "meanClay_5_15-SRM.tif"))

### download mean percent theta_s (saturated soil water content) of top 5-15 cm
  for(j in lons){
    for(k in lats){
      temp <- paste0(here("Data","Spatial", "Soils", "lat"), k,"_lon-", j, "_meantheta_s_5_15.tif")
      download.file(paste0("http://hydrology.cee.duke.edu/POLARIS/PROPERTIES/v1.0/theta_s/mean/5_15/lat"  , k, "_lon-", j, ".tif"), temp, mode="wb")
    }
  }
  
  # Merge theta_s files
  theta_s.files <- list.files(path=here("Data", "Spatial", "Soils"), pattern="meantheta_s_5_15.tif",   full.names=T)
  theta_s.rast <- lapply(theta_s.files,FUN=rast)
  theta_s.rast <- sprc(theta_s.rast)
  theta_s.merge <- merge(theta_s.rast, first=T)
  writeRaster(theta_s.merge, here("Data", "Spatial", "Soils", "meantheta_s_5_15-SRM.tif"),overwrite=T)
  
  ##download mean percent om (organic matter) of top 5-15 cm
  for(j in lons){
    for(k in lats){
      temp <- paste0(here("Data","Spatial", "Soils", "lat"), k,"_lon-", j, "_meanom_5_15.tif")
      download.file(paste0("http://hydrology.cee.duke.edu/POLARIS/PROPERTIES/v1.0/om/mean/5_15/lat"  , k, "_lon-", j, ".tif"), temp, mode="wb")
    }
  }
  
 # Merge om files
  om.files <- list.files(path=here("Data", "Spatial", "Soils"), pattern="meanom_5_15.tif",   full.names=T)
  om.rast <- lapply(om.files,FUN=rast)
  om.rast <- sprc(om.rast)
  om.merge <- merge(om.rast, first=T)
  writeRaster(om.merge, here("Data", "Spatial", "Soils", "meanom_5_15-SRM.tif"))
}
```

#### DEM

We obtained a 30 m resolution digital elevation model (DEM) from the USGS. For a strong prediction of the suitability of the aspen habitat in the SRME, we included the derivative variables, heat load index (HLI) and topographic surface index (THSI) in our model. The R spatialEco package was used to derive the heat load index from dem which is based on McCune, 2007; McCune and Keon, 2002. HLI was calculated in R using the package spatialEco

```{r DL_DEM}
if(!file.exists(here("Data", "Spatial","DEM"))){
  
  dir.create(here("Data", "Spatial","DEM"), showWarnings = FALSE)
  
  SRM <- st_read(here("Data", "Spatial", "Ecoregions",
"us_eco_l3.shp")) %>% filter(US_L3NAME == 'Southern Rockies') %>% st_transform(crs=5071) %>% st_buffer(20000)

  # 30 m 
  dem <- get_tiles(data=SRM, output_prefix = here("Data", "Spatial", "DEM", "DEM30"), services="elevation",   resolution=30)
dem.rast <- lapply(dem$elevation,FUN=rast)
  for(j in 2:length(dem.rast)){dem.rast[[j]] <-  terra::project(dem.rast[[j]], dem.rast[[1]], align=T)}
  dem.sprc <- sprc(dem.rast)
  dem.mosaic <- mosaic(dem.sprc)
  writeRaster(dem.mosaic, here("Data", "Spatial", "DEM", "DEM30-mosaic.tif"), overwrite=T)
  
 # 90 m 
  dem <- get_tiles(data=SRM, output_prefix = here("Data", "Spatial", "DEM", "DEM90"), services="elevation",   resolution=90)
dem.rast <- lapply(dem$elevation,FUN=rast)
  for(j in 2:length(dem.rast)){dem.rast[[j]] <-  terra::project(dem.rast[[j]], dem.rast[[1]], align=T)}
  dem.sprc <- sprc(dem.rast)
  dem.mosaic <- mosaic(dem.sprc)
  writeRaster(dem.mosaic, here("Data", "Spatial", "DEM", "DEM90-mosaic.tif"), overwrite=T)
   
  
  # 250 m 
  dem <- get_tiles(data=SRM, output_prefix = here("Data", "Spatial", "DEM", "DEM250"), services="elevation",   resolution=250)
  dem.rast <- lapply(dem$elevation,FUN=rast)
  writeRaster(dem.rast[[1]], here("Data", "Spatial", "DEM", "DEM250.tif"), overwrite=T)
}
```

```{r Calc_HLI, eval=F}
# Heat load index
if(!file.exists(here("Data","Spatial", "DEM", "DEM30-mosaic-HLI.tif"))){
  dem.mosaic <- rast(here(here("Data","Spatial", "DEM", "DEM30-mosaic.tif")))
  hli.rast <- hli(dem.mosaic, force.hemisphere = "northern")
  writeRaster(hli.rast, here("Data","Spatial", "DEM", "DEM30-mosaic-HLI.tif"))
}
```

```{r Calc_TPI3, eval=F}
# Topographic position index 3 cell neighborhood
if(!file.exists(here("Data","Spatial", "DEM", "DEM30-mosaic-TPI3.tif"))){
  dem.mosaic <- rast(here(here("Data","Spatial", "DEM", "DEM30-mosaic.tif")))
  tpi.rast <- tpi(dem.mosaic, scale=3)
  writeRaster(tpi.rast, here("Data","Spatial", "DEM", "DEM30-mosaic-TPI3.tif"))
}
```

```{r Calc_TPI15, eval=F}
# Topographic position index 15 cell neighborhood
if(!file.exists(here("Data","Spatial", "DEM", "DEM30-mosaic-TPI15.tif"))){
  dem.mosaic <- rast(here(here("Data","Spatial", "DEM", "DEM30-mosaic.tif")))
  tpi.rast <- tpi(dem.mosaic, scale=15)
  writeRaster(tpi.rast, here("Data","Spatial", "DEM", "DEM30-mosaic-TPI15.tif"))
}
```

#### Climate data

We obtained gridded climate data from the AdaptWest database, which provides downscaled historical climate data from PRISM and future climate data from WorldClim. Both datasets are downscaled to 1 km using the software ClimateNA. Specifically, to represent historical climate conditions we obtained normals for the 1981-2010 period.

Future climate projections were based on outputs from the ensemble mean of eight individual atmosphere-ocean models (AOGCMs) under two emissions scenarios (i.e., Shared Socioeconomic Pathways; SSPs) generated under the sixth phase of Coupled Model Intercomparison Project (CMIP6). Specifically here we use data from the SSP2-4.5, a and SSP5-8.5, which assumes very high emissions

RCP 4.5 assumes moderate increases in emissions through 2040, followed by declines, while RCP 8.5 assumes substantial increases in emissions through 2100 (Riahi et al., 2011). Due to computational limitations, we reduced the number of GCMs used in final analyses to three (under two RCPs for a total of six potential trajectories) that span the range of projected changes in climate throughout the 21st century (Supporting Information Appendix S2). We used annual actual ev

We obatined

```{r DL_climatedata, eval=F}
dir.create(here("Data","Spatial", "Climate"))
if(!file.exists(here("Data","Spatial", "Climate", "ClimateNA"))){
  dir.create(here("Data","Spatial", "Climate", "ClimateNA"), showWarnings = FALSE)
  
  # Climate normals
  ## Monthly variables
  temp <- here("Data","Spatial", "Climate", "ClimateNA", "Normal_1981_2010_monthly.zip")
  download.file("https://s3-us-west-2.amazonaws.com/www.cacpd.org/CMIP6v73/normals/Normal_1981_2010_monthly.zip", temp, mode="wb")
  unzip(temp, exdir=here("Data", "Spatial", "Climate", "CLimateNA"))
  
  ## Bioclimatic variables
  temp <- here("Data","Spatial", "Climate", "ClimateNA", "Normal_1981_2010_bioclim.zip")
  download.file("https://s3-us-west-2.amazonaws.com/www.cacpd.org/CMIP6v73/normals/Normal_1981_2010_bioclim.zip", temp, mode="wb")
  unzip(temp, exdir=here("Data", "Spatial", "Climate", "CLimateNA"))
  
  ## 2011-2040 Emission Scenario SSP2-4.5
  temp <- here("Data","Spatial", "Climate", "ClimateNA","ensemble_8GCMs_ssp245_2011_2040_bioclim.zip")
  download.file("https://s3-us-west-2.amazonaws.com/www.cacpd.org/CMIP6v73/ensembles/ensemble_8GCMs_ssp245_2011_2040_bioclim.zip", temp, mode="wb")
  unzip(temp, exdir=here("Data", "Spatial", "Climate", "CLimateNA"))
  
  ## 2040-2070 Emission Scenario SSP2-4.5
  temp <- here("Data","Spatial", "Climate", "ClimateNA","ensemble_8GCMs_ssp245_2041_2070_bioclim.zip")
  download.file("https://s3-us-west-2.amazonaws.com/www.cacpd.org/CMIP6v73/ensembles/ensemble_8GCMs_ssp245_2041_2070_bioclim.zip", temp, mode="wb")
  unzip(temp, exdir=here("Data", "Spatial", "Climate", "CLimateNA"))
  
  ## 2071-2100 Emission Scenario SSP2-4.5
  temp <- here("Data","Spatial", "Climate", "ClimateNA","ensemble_8GCMs_ssp245_2071_2100_bioclim.zip")
  download.file("https://s3-us-west-2.amazonaws.com/www.cacpd.org/CMIP6v73/ensembles/ensemble_8GCMs_ssp245_2071_2100_bioclim.zip", temp, mode="wb")
  unzip(temp, exdir=here("Data", "Spatial", "Climate", "CLimateNA"))
 
  ## 2011-2040 Emission Scenario SSP3-7.0
  temp <- here("Data/Spatial/Climate/CLimateNA/ensemble_8GCMs_ssp370_2011_2040_bioclim.zip")
  download.file("https://s3-us-west-2.amazonaws.com/www.cacpd.org/CMIP6v73/ensembles/ensemble_8GCMs_ssp370_2011_2040_bioclim.zip", temp )
  unzip(temp, exdir=here("Data/Spatial/Climate/CLimateNA"))
  
  temp <- here("Data/Spatial/Climate/CLimateNA/ensemble_8GCMs_ssp370_2011_2040_monthly.zip")
  download.file("https://s3-us-west-2.amazonaws.com/www.cacpd.org/CMIP6v73/ensembles/ensemble_8GCMs_ssp370_2011_2040_monthly.zip", temp )
  unzip(temp, exdir=here("Data/Spatial/Climate/CLimateNA"))

  ## 2040-2070 Emission Scenario SSP3-7.0
  temp <- here("Data/Spatial/Climate/CLimateNA/ensemble_8GCMs_ssp370_2041_2070_bioclim.zip")
  download.file("https://s3-us-west-2.amazonaws.com/www.cacpd.org/CMIP6v73/ensembles/ensemble_8GCMs_ssp370_2041_2070_bioclim.zip", temp )
  unzip(temp, exdir=here("Data/Spatial/Climate/CLimateNA"))
  
   temp <- here("Data/Spatial/Climate/CLimateNA/ensemble_8GCMs_ssp370_2041_2070_monthly.zip")
  download.file("https://s3-us-west-2.amazonaws.com/www.cacpd.org/CMIP6v73/ensembles/ensemble_8GCMs_ssp370_2041_2070_monthly.zip", temp )
  unzip(temp, exdir=here("Data/Spatial/Climate/CLimateNA"))

  ## 2071-2100 Emission Scenario SSP3-7.0
  temp <- here("Data/Spatial/Climate/CLimateNA/ensemble_8GCMs_ssp370_2071_2100_bioclim.zip")
  download.file("https://s3-us-west-2.amazonaws.com/www.cacpd.org/CMIP6v73/ensembles/ensemble_8GCMs_ssp370_2071_2100_bioclim.zip", temp )
  unzip(temp, exdir=here("Data/Spatial/Climate/CLimateNA"))
  
  temp <- here("Data/Spatial/Climate/CLimateNA/ensemble_8GCMs_ssp370_2071_2100_monthly.zip")
  download.file("https://s3-us-west-2.amazonaws.com/www.cacpd.org/CMIP6v73/ensembles/ensemble_8GCMs_ssp370_2071_2100_monthly.zip", temp )
  unzip(temp, exdir=here("Data/Spatial/Climate/CLimateNA"))
  
   ##2011-2040 Emission Scenario SSP5-8.5
  temp <- here("Data","Spatial", "Climate", "ClimateNA","ensemble_8GCMs_ssp585_2011_2040_bioclim.zip")
  download.file("https://s3-us-west-2.amazonaws.com/www.cacpd.org/CMIP6v73/ensembles/ensemble_8GCMs_ssp585_2011_2040_bioclim.zip", temp, mode="wb")
  unzip(temp, exdir=here("Data", "Spatial", "Climate", "CLimateNA"))
 
  ##2041-2070 Emission Scenario SSP5-8.5
  temp <- here("Data","Spatial", "Climate", "ClimateNA","ensemble_8GCMs_ssp585_2041_2070_bioclim.zip")
  download.file("https://s3-us-west-2.amazonaws.com/www.cacpd.org/CMIP6v73/ensembles/ensemble_8GCMs_ssp585_2041_2070_bioclim.zip", temp, mode="wb")
  unzip(temp, exdir=here("Data", "Spatial", "Climate", "CLimateNA"))
  
  ##2071-2100 Emission Scenario SSP5-8.5
  temp <- here("Data","Spatial", "Climate", "ClimateNA","ensemble_8GCMs_ssp585_2071_2100_bioclim.zip")
  download.file("https://s3-us-west-2.amazonaws.com/www.cacpd.org/CMIP6v73/ensembles/ensemble_8GCMs_ssp585_2071_2100_bioclim.zip", temp, mode="wb")
  unzip(temp, exdir=here("Data", "Spatial", "Climate", "CLimateNA"))
}
```

```{r Calc_Derived_Climate_Variables, eval=F}
dir.create(here("Data", "Spatial", "Climate", "ClimateNA", "Derived"))
monthly.climate.rasters <- rast(list.files(here("Data", "Spatial", "Climate", "ClimateNA", "Normal_1981_2010/Normal_1981_2010_monthly"), full.names=T))

monthly.climate.rasters <- crop(monthly.climate.rasters, SRM)
names(monthly.climate.rasters) <- do.call(c, strsplit(sapply(strsplit(list.files(here("Data", "Spatial", "Climate", "ClimateNA", "Normal_1981_2010/Normal_1981_2010_monthly"), full.names=F), split="Normal_1981_2010_"), "[", 2), split=".tif"))

bioclimate.rasters <- rast(list.files(here("Data/Spatial/Climate/ClimateNA/Normal_1981_2010/Normal_1981_2010_bioclim"), pattern=".tif", full.names=T))
names(bioclimate.rasters) <- sapply(strsplit(do.call(c, strsplit(list.files(here("Data/Spatial/Climate/ClimateNA/Normal_1981_2010/Normal_1981_2010_bioclim"), pattern=".tif", full.names=F), split=".tif")), split="Normal_1981_2010_"), "[", 2)

SRM <- st_read(here("Data", "Spatial", "Ecoregions", "us_eco_l3.shp")) %>% filter(US_L3NAME == 'Southern Rockies') %>% st_buffer(5000) %>%  st_transform(crs(monthly.climate.rasters))
monthly.climate.rasters <- terra::crop(monthly.climate.rasters, SRM)
bioclimate.rasters <- terra::crop(bioclimate.rasters, SRM)

#ADI 
ADI <- (bioclimate.rasters[['DD5']]^0.5)/bioclimate.rasters[['MAP']]
writeRaster(ADI, filename=(here("Data", "Spatial", "Climate", "ClimateNA", "Derived", "Normal_1981_2010_ADI.tif")))

#GSP
GSP <- sum(monthly.climate.rasters[[paste0("PPT",c("04", "05", "06", "07","08","09"))]])
writeRaster(GSP, filename=(here("Data", "Spatial", "Climate", "ClimateNA", "Derived", "Normal_1981_2010_GSP.tif")))

#PRATIO
PRATIO <- GSP/bioclimate.rasters[["MAP"]]
writeRaster(PRATIO, filename=(here("Data", "Spatial", "Climate", "ClimateNA", "Derived", "Normal_1981_2010_PRATIO.tif")))

#GSPDD5
GSPDD5 <- GSP/bioclimate.rasters[["DD5"]]
writeRaster(GSPDD5, filename=(here("Data", "Spatial", "Climate", "ClimateNA", "Derived", "Normal_1981_2010_GSPDD5.tif")))

#TMAX 
TMAX <- max(monthly.climate.rasters[[paste0("Tmax",c("04", "05", "06", "07","08","09"))]])
writeRaster(TMAX, filename=(here("Data", "Spatial", "Climate", "ClimateNA", "Derived", "Normal_1981_2010_TMAX.tif")), overwrite=T)


select.scenarios<- c("ssp245", "ssp585")
select.years.all <- c("_2011_2040", "_2041_2070", "_2071_2100")
for(select.scenario in select.scenarios){
  
  for(select.year in select.years.all){
  monthly.climate.rasters <- rast(list.files(paste0(here("Data", "Spatial", "Climate", "ClimateNA"), "/ensemble_8GCMs_", select.scenario, select.year, "/ensemble_8GCMs_", select.scenario, select.year,"_monthly"), full.names=T))
  names(monthly.climate.rasters) <- sapply(strsplit(do.call(c,strsplit(list.files(paste0(here("Data", "Spatial", "Climate", "ClimateNA"), "/ensemble_8GCMs_", select.scenario, select.year, "/ensemble_8GCMs_", select.scenario, select.year,"_monthly"), full.names=F), split=".tif")),split=paste0("ensemble_8GCMs_", select.scenario, select.year, "_")), "[", 2)

 bioclimate.rasters <- rast(list.files(paste0(here("Data", "Spatial", "Climate", "ClimateNA"), "/ensemble_8GCMs_", select.scenario, select.year, "/ensemble_8GCMs_", select.scenario, select.year,"_bioclim"), full.names=T))
  names(bioclimate.rasters) <- sapply(strsplit(do.call(c,strsplit(list.files(paste0(here("Data", "Spatial", "Climate", "ClimateNA"), "/ensemble_8GCMs_", select.scenario, select.year, "/ensemble_8GCMs_", select.scenario, select.year,"_bioclim"), full.names=F), split=".tif")),split=paste0("ensemble_8GCMs_", select.scenario, select.year, "_")), "[", 2)
 
 SRM <- st_read(here("Data", "Spatial", "Ecoregions", "us_eco_l3.shp")) %>% filter(US_L3NAME == 'Southern Rockies') %>% st_buffer(5000) %>%  st_transform(crs(monthly.climate.rasters))

 monthly.climate.rasters <- crop(monthly.climate.rasters, SRM)
 bioclimate.rasters <- crop(bioclimate.rasters, monthly.climate.rasters)
 
 #ADI 
 ADI <- (bioclimate.rasters[['DD5']]^0.5)/bioclimate.rasters[['MAP']]
 writeRaster(ADI, filename=paste0(here("Data", "Spatial", "Climate", "ClimateNA", "Derived"), "/", select.scenario, select.year, "_ADI.tif"), overwrite=T)
 
 #GSP
 GSP <- sum(monthly.climate.rasters[[paste0("PPT",c("04", "05", "06", "07","08","09"))]])
 writeRaster(GSP, filename=paste0(here("Data", "Spatial", "Climate", "ClimateNA", "Derived"), "/", select.scenario, select.year, "_GSP.tif"), overwrite=T)
 
 #PRATIO
 PRATIO <- GSP/bioclimate.rasters[["MAP"]]
 writeRaster(PRATIO, filename=paste0(here("Data", "Spatial", "Climate", "ClimateNA", "Derived"), "/", select.scenario, select.year, "_PRATIO.tif"), overwrite=T)
 
 #GSPDD5
 GSPDD5 <- GSP/bioclimate.rasters[["DD5"]]
 writeRaster(GSPDD5, filename=paste0(here("Data", "Spatial", "Climate", "ClimateNA", "Derived"), "/", select.scenario, select.year, "_GSPDD5.tif"), overwrite=T)
  print(select.year)
  }
  print(select.scenario)
}

```

## Data processing

### Downscaling

We downscaled all climatic variables from 1 km resolution to 250 m using gradient and inverse distance squared (GIDS) interpolation (Flint and Flint, 2012; Nalder and Wein, 1998), following methods outlined in Rodman et al., 2020.

```{r Downscale, eval=F}
source(here("Code", "GIDS-Downscaling-SJH.R"))

# Set desired projection
proj.proj <- "+proj=utm +zone=13 +ellps=GRS80 +datum=NAD83 +units=m +no_defs"

# Import study area boundary
study.area <- st_read(here("Data", "Spatial", "Ecoregions", "us_eco_l3.shp")) %>% filter(US_L3NAME == 'Southern Rockies') %>% st_transform(crs(proj.proj)) %>% st_buffer(20000)

# Import template for downscaling
template <- rast(here("Data", "Spatial", "DEM", "DEM250.tif"))
template <- template %>% terra::project(proj.proj)
template<- template %>% crop(study.area)
 
# Warning message happens because number of raster cells is not evenly divisible by number of cores on PC
dir.create(here("Data", "Spatial", "Downscaled"), showWarnings = FALSE)
select.climate.variables <-c("TD", "GSP", "MCMT", "PPT_sm", "MAR", "RH")
select.derived.climate.variables <-c( "PRATIO", "GSPDD5", "ADI", "GSP")

### NORMALS
for(j in select.climate.variables){
  if(!file.exists(paste0(here("Data", "Spatial", "Downscaled"), "/Normal_1981_2010_", j, "-downscaled.tif"))){
    ptm <- proc.time()
    clim <- rast(paste0(here("Data", "Spatial", "Climate", "CLimateNA", "Normal_1981_2010", "Normal_1981_2010_bioclim"), "/Normal_1981_2010_", j, ".tif"))
    clim <- clim %>% terra::project(proj.proj)
    clim <- clim %>% crop(study.area)
  
    if(j ==select.climate.variables[1]){template_coarse <- terra::project(template ,clim, method="bilinear")}   ## Creating second DEM at same resolution as climate grid; only do this for the first iteration
    
    ds_layer <- multiLevelInterpParrallel(boundary = study.area, ds_layer = clim,
                                        ancillary_list = list(template_coarse, template), 
                                        clip_dists = c(20000, 5000, 500))
  
    writeRaster(ds_layer, paste0(here("Data", "Spatial", "Downscaled"), "/Normal_1981_2010_", j, "-downscaled.tif"), overwrite=T)
    rm(ds_layer) # remove 
    gc() # clean up garbage (sometimes this helps)
    print(j) # print j so we know how far along our code is
    time <- proc.time() - ptm
    print(time[3]/60) # print time for each iteration 
  }

}


for(j in select.derived.climate.variables){
  if(!file.exists(paste0(here("Data", "Spatial", "Downscaled"), "/Normal_1981_2010_", j, "-downscaled.tif"))){
    ptm <- proc.time()
    clim <- rast(paste0(here("Data", "Spatial", "Climate", "CLimateNA", "Derived"), "/Normal_1981_2010_", j, ".tif"))
    clim <- clim %>% terra::project(proj.proj)
    clim <- clim %>% crop(study.area)
  
    if(j ==select.climate.variables[1]){template_coarse <- terra::project(template ,clim, method="bilinear")}   ## Creating second DEM at same resolution as climate grid; only do this for the first iteration
    
    ds_layer <- multiLevelInterpParrallel(boundary = study.area, ds_layer = clim,
                                        ancillary_list = list(template_coarse, template), 
                                        clip_dists = c(20000, 5000, 500))
  
    writeRaster(ds_layer, paste0(here("Data", "Spatial", "Downscaled"), "/Normal_1981_2010_", j, "-downscaled.tif"), overwrite=T)
    rm(ds_layer) # remove 
    gc() # clean up garbage (sometimes this helps)
    print(j) # print j so we know how far along our code is
    time <- proc.time() - ptm
    print(time[3]/60) # print time for each iteration 
  }

}

## FUTURE

select.climate.variables <-c("MCMT", "MAR", "RH")
select.derived.climate.variables <-c( "PRATIO", "GSPDD5", "ADI")
select.scenarios<- c("ssp245", "ssp585")
select.years.all <- c("_2011_2040", "_2041_2070", "_2071_2100")

for(select.scenario in select.scenarios){
  for(j in select.climate.variables){
    for(select.years in select.years.all){
      if(!file.exists(paste0(here("Data", "Spatial", "Downscaled"), "/ensemble_8GCMs_", select.scenario, select.years, j, "-downscaled.tif"))){
        ptm <- proc.time()
        clim <- rast(paste0(here("Data", "Spatial", "Climate", "CLimateNA"), "/ensemble_8GCMs_", select.scenario, select.years, "/", "ensemble_8GCMs_", select.scenario, select.years, "_bioclim/", "ensemble_8GCMs_", select.scenario, select.years,"_", j, ".tif"))
        clim <- clim %>% terra::project(proj.proj)
        clim <- clim %>% crop(study.area)
    
        if(j ==select.climate.variables[1]){template_coarse <- terra::project(template ,clim, method="bilinear")}   ## Creating second DEM at same resolution as climate grid; only do this for the first iteration
      
        ds_layer <- multiLevelInterpParrallel(boundary = study.area, ds_layer = clim,
                                          ancillary_list = list(template_coarse, template), 
                                          clip_dists = c(20000, 5000, 500))
    
        writeRaster(ds_layer, paste0(here("Data", "Spatial", "Downscaled"), "/ensemble_8GCMs_", select.scenario, select.years, "_", j, "-downscaled.tif"), overwrite=T)
        rm(ds_layer) # remove 
        gc() # clean up garbage (sometimes this helps)
        print(j) # print j so we know how far along our code is
        time <- proc.time() - ptm
        print(time[3]/60) # print time for each iteration
      }
    }
  }
  print(select.scenario)
}

for(select.scenario in select.scenarios){
  for(j in select.derived.climate.variables){
    for(select.years in select.years.all){
      if(!file.exists(paste0(here("Data", "Spatial", "Downscaled"), "/", select.years, j, "-downscaled.tif"))){
        ptm <- proc.time()
        clim <- rast(paste0(here("Data", "Spatial", "Climate", "CLimateNA", "Derived"), "/", select.scenario, select.years, "_", j,  ".tif"))
        clim <- clim %>% terra::project(proj.proj)
        clim <- clim %>% crop(study.area)
    
       if(j ==select.climate.variables[1]){template_coarse <- terra::project(template ,clim, method="bilinear")}   ## Creating second DEM at same resolution as climate grid; only do this for the first iteration
      
        ds_layer <- multiLevelInterpParrallel(boundary = study.area, ds_layer = clim, ancillary_list = list(template_coarse, template), clip_dists = c(20000, 5000, 500))
    
       writeRaster(ds_layer, paste0(here("Data", "Spatial", "Downscaled"), "/ensemble_8GCMs_", select.scenario, select.years,"_", j, "-downscaled.tif"), overwrite=T)
       rm(ds_layer) # remove 
       gc() # clean up garbage (sometimes this helps)
       print(j) # print j so we know how far along our code is
       time <- proc.time() - ptm
       print(time[3]/60) # print time for each iteration 
      }
    }
  }
}


```

### Resample

```{r Resample, eval=F}
aspen <- rast(here("Data", "Spatial", "Aspen", "srme_skcv_probability_mosaic.tif"))
aspen90 <- aggregate(aspen, fact=9, fun="mean", cores=cores-1, filename=here("Data", "Spatial", "Aspen", "srme_skcv_probability_mosaic-90.tif"),overwrite=T)


#aggregate 
if(!file.exists(filename=here("Data", "Spatial", "Soils", "Soils90.tif"))){
  ph <- rast(here("Data", "Spatial", "Soils", "meanPh_5_15-SRM.tif"))  
  clay <- rast(here("Data", "Spatial", "Soils", "meanClay_5_15-SRM.tif"))
  om <- rast(here("Data", "Spatial", "Soils", "meanom_5_15-SRM.tif")) 
  theta_s <- rast(here("Data", "Spatial", "Soils", "meantheta_s_5_15-SRM.tif")) 
  soil <- c(ph, clay, om, theta_s) %>% terra::project(aspen90) %>% aggregate(soil, fact=3, fun="mean",cores=cores-1)
  names(soil) <- c("pH", "clay", "om", "thetas")
  soil.re <- resample(soil, aspen90, method="near", threads=T, filefname=here("Data", "Spatial", "Soils", "Soils90.tif"), overwrite=TRUE)
}

#topographic data
if(!file.exists(filename=here("Data", "Spatial", "DEM", "Topo90.tif"))){
  tpi3 <- rast(here("Data", "Spatial", "DEM", "DEM30-mosaic-TPI3.tif")) 
  tpi15 <- rast(here("Data", "Spatial", "DEM", "DEM30-mosaic-TPI15.tif"))
  hli <- rast(here("Data", "Spatial", "DEM", "DEM30-mosaic-HLI.tif"))
  topo <- c(tpi3, tpi15, hli) %>% terra::project(crs(aspen)) %>% aggregate(soil, fact=3, fun="mean",cores=cores-1)
  names(topo) <- c("tpi3", "tpi15", "hli")
  topo.re <- resample(topo, aspen, method="average", threads=T, filename=here("Data", "Spatial", "DEM", "Topo90.tif"),overwrite=TRUE)
}

# climate data
if(!file.exists(filename=here("Data", "Spatial", "Downscaled", "Normals90.tif"))){
  climate <- rast(list.files(here("Data", "Spatial", "Downscaled"), pattern="Normal", full.names=T))
  names(climate) <- sapply(sapply(sapply(sapply(list.files(here("Data", "Spatial", "Downscaled"), pattern="Normal", full.names=T), strsplit, split="2010_"), "[", 2), strsplit, split="-downscaled.tif"), "[", 1)
  climate.re <- resample(climate, aspen, method="near", threads=T, filename=here("Data", "Spatial", "Downscaled", "Normals90.tif"),overwrite=TRUE)
}

# climate 2040 data
if(!file.exists(filename=here("Data", "Spatial", "Downscaled", "ensemble_8GCMs_ssp370_2011_2040_90.tif"))){
  climate <- list.files(here("Data", "Spatial", "Downscaled"), pattern="ensemble_8GCMs_ssp370_2011_2040_", full.names=T)
  climate <- rast(climate) %>% terra::project(crs(aspen90))
  names(climate) <- sapply(sapply(sapply(sapply(list.files(here("Data", "Spatial", "Downscaled"), pattern="ensemble_8GCMs_ssp370_2011_2040_", full.names=T), strsplit, split="ensemble_8GCMs_ssp370_2011_2040_"), "[", 2), strsplit, split="-downscaled.tif"), "[", 1)
  climate.re <- resample(climate, aspen90, method="near", threads=T, filename=here("Data", "Spatial", "Downscaled", "ensemble_8GCMs_ssp370_2011_2040_90.tif"),overwrite=TRUE)
}

# climate 2070 data
if(!file.exists(filename=here("Data", "Spatial", "Downscaled", "ensemble_8GCMs_ssp370_2041_2070_90.tif"))){
  climate <- list.files(here("Data", "Spatial", "Downscaled"), pattern="ensemble_8GCMs_ssp370_2041_2070_", full.names=T)
  climate <- rast(climate) %>% terra::project(crs(aspen90))
  names(climate) <- sapply(sapply(sapply(sapply(list.files(here("Data", "Spatial", "Downscaled"), pattern="ensemble_8GCMs_ssp370_2041_2070_", full.names=T), strsplit, split="ensemble_8GCMs_ssp370_2041_2070_"), "[", 2), strsplit, split="-downscaled.tif"), "[", 1)
  climate.re <- resample(climate, aspen90, method="near", threads=T, filename=here("Data", "Spatial", "Downscaled", "ensemble_8GCMs_ssp370_2041_2070_90.tif"),overwrite=TRUE)
}

# climate 2100 data
if(!file.exists(filename=here("Data", "Spatial", "Downscaled", "ensemble_8GCMs_ssp370_2071_2100_90.tif"))){
  climate <- list.files(here("Data", "Spatial", "Downscaled"), pattern="ensemble_8GCMs_ssp370_2071_2100_", full.names=T)
  climate <- rast(climate) %>% terra::project(crs(aspen90))
  names(climate) <- sapply(sapply(sapply(sapply(list.files(here("Data", "Spatial", "Downscaled"), pattern="ensemble_8GCMs_ssp370_2071_2100_", full.names=T), strsplit, split="ensemble_8GCMs_ssp370_2071_2100_"), "[", 2), strsplit, split="-downscaled.tif"), "[", 1)
  climate.re <- resample(climate, aspen90, method="near", threads=T, filename=here("Data", "Spatial", "Downscaled", "ensemble_8GCMs_ssp370_2071_2100_90.tif"),overwrite=TRUE)
}
```

### Model

#### Data preparation

```{r DataPrep}
# Import response variable
aspen90.prob <- rast(here("Data", "Spatial", "Aspen",  "srme_skcv_distribution_binopt-90.tif"))
names(aspen90.prob) <- "aspen.prob"
aspen90.prob01 <- aspen90.prob
aspen90.prob01[aspen90.prob01>0]<-1
names(aspen90.prob01) <- "aspen.presence"

SRM <- st_read(here("Data", "Spatial", "Ecoregions", "us_eco_l3.shp")) %>% filter(US_L3NAME == 'Southern Rockies') %>% st_transform(crs(aspen90.prob))
aspen90.prob <- terra::mask(aspen90.prob, SRM)
aspen90.prob01 <-terra::mask(aspen90.prob01, SRM)

# Import predictor variables
topo90 <- rast(here("Data", "Spatial", "DEM", "Topo90.tif"))
soil90 <- rast(here("Data", "Spatial", "Soils", "Soils90.tif"))
normals90 <- rast(here("Data", "Spatial", "Downscaled", "Normals90.tif"))

# Compile data
aspen.pts <- aspen90.prob01 %>% as.points(na.rm=T)
aspen.pts <- terra::extract(aspen90.prob,aspen.pts, bind=T, xy=T, cells=T) 
aspen.pts <- extract(normals90, aspen.pts, bind=T)
aspen.pts <- extract(topo90, aspen.pts, bind=T)
aspen.pts <- extract(soil90, aspen.pts, bind=T)

# Spatially thin data
template <- rast(here("Data", "Spatial", "Climate", "ClimateNA", "Derived", "Normal_1981_2010_GSPDD5.tif")) %>% as.points(na.rm=T) %>% terra::project(crs(aspen90.prob))
aspen90.1km <- extract(aspen90.prob,template,cells=T) 
aspen.sample.pts <- aspen.pts %>% as.data.frame() %>% filter(cell %in% aspen90.1km$cell) #

# Remove collinear variables
preference.order <- c("ADI",  "PRATIO", "GSPDD5", "GSP", "MCMT", "PPT_sm", "TD","RH", "MAR")
dat <- aspen.sample.pts %>% na.omit() %>% group_by(aspen.presence) %>%  sample_n(size=5000)
dat$aspen.presence <- dat$aspen.presence %>% as.factor()
pred.vars <- dat[, c(preference.order, "om", "tpi3", "pH", "thetas", "tpi15", "clay", "hli")] %>% spatialRF::auto_cor(cor.threshold = 0.7,preference.order = preference.order) %>% spatialRF::auto_vif(vif.threshold = 5,preference.order = preference.order)
pred.vars <- pred.vars$selected.variables
remove.vars <- c(preference.order, "om", "tpi3", "pH", "thetas", "tpi15", "clay", "hli")[!c(preference.order, "om", "tpi3", "pH", "thetas", "tpi15", "clay", "hli") %in% pred.vars]

dat_split <- initial_split(
  dat <- dat, 
  prop = 0.5, 
  strata = aspen.presence
)

# preprocessing "recipe"
presence.recipe<- 
  recipe(aspen.presence ~ ., data = training(dat_split))  %>%
  # remove collinear variables
  step_rm(!!!syms(remove.vars)) %>% 
  # normalize all numeric variables except the outcome and ID variables
  step_normalize(all_numeric(), -all_outcomes(), -aspen.prob, -x, -y, -cell) %>%
  update_role(aspen.prob, x, y,cell, new_role="ID")

# split training dataset to tune hyperparameters
cv_folds <- training(dat_split) %>% vfold_cv(v=5, strata=aspen.presence)
```

#### GLM

```{r}
# Specify model
glmnet_spec <- 
  logistic_reg(penalty = tune(), mixture = 1) %>%
  set_engine("glmnet") %>% 
  set_mode("classification")

# Create workflow
glmnet_wflow <- 
  workflow() %>% 
  add_recipe(presence.recipe) %>% 
  add_model(glmnet_spec)

# Tune model
### Set parameters to be tuned
glmnet_params <- 
  dials::parameters(
    finalize(penalty())
)

## Create grid of search values
glmnet_grid <- tibble(penalty = 10^seq(-4, -1, length.out = 30))


### Perform tuning
glmnet_tuned <- tune::tune_grid(
  object = glmnet_wflow,
  resamples = cv_folds,
  grid = glmnet_grid,
  metrics = metric_set(recall, precision, f_meas, accuracy, kap, roc_auc, sens, spec),
  control = tune::control_grid(verbose = TRUE)
)

# Finalize workflow
glmnet_best_params <- glmnet_tuned %>% tune::select_best("roc_auc")
final_glmnet <- glmnet_wflow %>% finalize_workflow(glmnet_best_params)

# Evaluate model on training dataset
glmnet_res <- 
  final_glmnet%>% 
  fit_resamples(
    resamples = cv_folds, 
    metrics = metric_set(recall, precision, f_meas, accuracy, kap, roc_auc, sens, spec),
    control = control_resamples(save_pred = TRUE)
    ) 

glmnet_res %>%  collect_metrics(summarize = TRUE) %>% mutate(Dataset="Calibration") %>% mutate(Model="GLMNET") %>% write.csv(here("Results", "GLMNET-calibration-stats.csv"))

# Evaluate model on testing dataset
glmnet_last_fit <- last_fit(final_glmnet,
                         split=dat_split,
                         metrics = metric_set(recall, precision, f_meas, accuracy, kap,roc_auc, sens, spec))

glmnet_last_fit %>% collect_metrics() %>% mutate(Dataset="Validation", Model="GLMNET") %>% write.csv(here("Results", "GLMNet-validation-stats.csv"))

# Variable importance
vi <- glmnet_last_fit%>% 
  pluck(".workflow", 1) %>%   
  extract_fit_parsnip() %>% 
  vip()
write.csv(vi$data %>% mutate(Model="GLMNET"), here("Results", "vip-glmnet.csv"))

# Partial dependence and accumualted local effects
explainer_glmnet<- explain_tidymodels(final_glmnet %>% fit(training(dat_split)), 
                                    data=training(dat_split) %>% as.data.frame() %>% select(-aspen.presence), 
                                    y=training(dat_split) %>% pull(aspen.presence) %>% as.numeric(),
                                    type="classification", verbose=F
)

pdp <- model_profile(explainer_glmnet , N = 500, variables = pred.vars, type="partial")
pdp$agr_profiles %>% mutate(method="PDP", Model="GLMNET") %>% write.csv(here("Results", "pdp-GLMNET.csv"))
ale <- model_profile(explainer_glmnet , N = 500, variables = pred.vars, type="accumulated")
ale$agr_profiles %>% mutate(method="ALE", Model="GLMNET")  %>% write.csv(here("Results", "ale-GLMNET.csv"))

# predict on entire dataset in five separate chunks
aspen.pts.df <- aspen.pts %>% as.data.frame() %>% na.omit()
aspen.pts.df$cut <- cut(1:nrow(aspen.pts.df), breaks=5)
aspen.pts.df$predicted <- NA
for(j in unique(aspen.pts.df$cut)){
  all_prediction <-final_glmnet %>% 
    fit(testing(dat_split)) %>% 
    predict(new_data = aspen.pts.df[aspen.pts.df$cut==j, ], type="prob")
  aspen.pts.df[aspen.pts.df$cut==j, ]$predicted <- all_prediction$`.pred_1`
  print(j)
}

aspen90.pred <- aspen90.prob01
aspen90.pred.cells <- cells(aspen90.pred)
aspen90.pred[!aspen90.pred.cells] <-  -9999
aspen90.pred.bak <- aspen90.pred

aspen90.pred <- aspen90.prob01
aspen90.pred[aspen.pts.df$cell] <-  aspen.pts.df$predicted
writeRaster(aspen90.pred, here("Data", "Spatial", "predicted_1981-2010-glmnet.tif"),overwrite=T)

aspen90.pred[aspen90.pred>=0.5] <- 1
aspen90.pred[aspen90.pred<0.5] <- 0
aspen90.preds.dif <- aspen90.prob01
aspen90.preds.dif[aspen90.preds.dif==1] <- 10
aspen90.preds.dif <- aspen90.preds.dif - aspen90.pred
aspen90.preds.dif[aspen90.preds.dif==-1] <- 2 # false positive
aspen90.preds.dif[aspen90.preds.dif==9] <- 1 # correct
aspen90.preds.dif[aspen90.preds.dif==10] <- -1 # false negative
writeRaster(aspen90.preds.dif, here("Data", "Spatial", "predicted_1981-2010-glmnet-classerror.tif"),overwrite=T)

plot(aspen90.preds.dif, col=c("#4d4d4d", "gray", "#d53e4f", "#3288bd"))

# Predict
yearz <- c("2011_2040", "2041_2070", "2071_2100")
for(years in yearz){
  climate90 <- rast(paste0(here("Data", "Spatial", "Downscaled"), "/ensemble_8GCMs_ssp370_", years, "_90.tif"))
  # Compile data
  aspen.pts <- aspen90.prob01 %>% as.points(na.rm=T)
  aspen.pts <- terra::extract(aspen90.prob,aspen.pts, bind=T, xy=T, cells=T) 
  aspen.pts <- extract(climate90, aspen.pts, bind=T)
  aspen.pts <- extract(topo90, aspen.pts, bind=T)
  aspen.pts <- extract(soil90, aspen.pts, bind=T)
  
  # predict on entire dataset in five separate chunks
  aspen.pts.df <- aspen.pts %>% as.data.frame() %>% na.omit()
  aspen.pts.df$cut <- cut(1:nrow(aspen.pts.df), breaks=5)
  aspen.pts.df$predicted <- NA
  for(j in unique(aspen.pts.df$cut)){
    all_prediction <-final_glmnet %>% 
      fit(testing(dat_split)) %>% 
      predict(new_data = aspen.pts.df[aspen.pts.df$cut==j, ], type="prob")
    aspen.pts.df[aspen.pts.df$cut==j, ]$predicted <- all_prediction$`.pred_1`
    print(j)
  }
  
  aspen90.pred <- aspen90.prob01
  aspen90.pred.cells <- cells(aspen90.pred)
  aspen90.pred[!aspen90.pred.cells] <-  -9999
  aspen90.pred.bak <- aspen90.pred
  
  aspen90.pred <- aspen90.prob01
  aspen90.pred[aspen.pts.df$cell] <-  aspen.pts.df$predicted
  writeRaster(aspen90.pred, paste0(here("Data", "Spatial"), "/predicted_", years, "-glmnet.tif"),overwrite=T)

}
```

#### Gradient boosting

```{r}
# Specify model
xgb_spec <- 
  boost_tree(
    trees=1000,
    tree_depth=tune(), min_n=tune(), loss_reduction=tune(), ## model complexity
    learn_rate=tune() # step size
  ) %>%
  set_engine("xgboost", objective = "binary:logistic") %>% 
  set_mode("classification")

# Create workflow
xgb_wflow <- 
  workflow() %>% 
  add_recipe(presence.recipe) %>% 
  add_model(xgb_spec)

# Tune model
### Set parameters to be tuned
xgboost_params <- 
  dials::parameters(
    tree_depth(),
    min_n(),
    loss_reduction(),
    learn_rate()
)

## Create grid of search values
xgboost_grid <- 
  dials::grid_latin_hypercube(
    xgboost_params, 
    size = 50
)
### Perform tuning
xgb_tuned <- tune::tune_grid(
  object = xgb_wflow,
  resamples = cv_folds,
  grid = xgboost_grid,
  metrics = metric_set(recall, precision, f_meas, accuracy, kap, roc_auc, sens, spec),
  control = tune::control_grid(verbose = TRUE)
)

# Finalize workflow
xgboost_best_params <- xgb_tuned  %>% tune::select_best("roc_auc") # min_n=18, tree_depth=6, learn_rate=0.00835, loss_reduction=0.00125
final_xgb <- xgb_wflow %>% finalize_workflow(xgboost_best_params)

# Evaluate model on training dataset
xgb_res <- 
  final_xgb %>% 
  fit_resamples(
    resamples = cv_folds, 
    metrics = metric_set(recall, precision, f_meas, accuracy, kap, roc_auc, sens, spec),
    control = control_resamples(save_pred = TRUE)
    ) 

xgb_res %>% collect_metrics(summarize = TRUE) %>% mutate(Dataset="Calibration") %>% mutate(Model="XGB") %>% write.csv(here("Results", "XGB-calibration-stats.csv"))

# Evaluate model on testing dataset
xgb_last_fit <- last_fit(final_xgb,
                         split=dat_split,
                         metrics = metric_set(recall, precision, f_meas, accuracy, kap,roc_auc, sens, spec))

xgb_last_fit %>% collect_metrics() %>% mutate(Model="XGB")%>% mutate(Dataset="Validation") %>% write.csv(here("Results", "XGB-validation-stats.csv"))

# Variable importance
vi <- xgb_last_fit %>% 
  pluck(".workflow", 1) %>%   
  extract_fit_parsnip() %>% 
  vip()
write.csv(vi$data %>% mutate(Model="XGB"), here("Results", "vip-xgb.csv"))

# Partial dependence and accumualted local effects
explainer_xgb <- explain_tidymodels(final_xgb %>% fit(training(dat_split)), 
                                    data=training(dat_split) %>% as.data.frame() %>% select(-aspen.presence), 
                                    y=training(dat_split) %>% pull(aspen.presence) %>% as.numeric(),
                                    type="classification", verbose=F
)

pdp <- model_profile(explainer_xgb , N = 500, variables = pred.vars, type="partial")
pdp$agr_profiles %>% mutate(method="PDP", Model="XGB") %>% write.csv(here("Results", "pdp-XGB.csv"))
ale <- model_profile(explainer_xgb , N = 500, variables = pred.vars, type="accumulated")
ale$agr_profiles %>% mutate(method="ALE", Model="XGB")  %>% write.csv(here("Results", "ale-XGB.csv"))

# predict on entire dataset in five separate chunks
aspen.pts.df <- aspen.pts %>% as.data.frame() %>% na.omit()
aspen.pts.df$cut <- cut(1:nrow(aspen.pts.df), breaks=5)
aspen.pts.df$predicted <- NA
for(j in unique(aspen.pts.df$cut)){
  all_prediction <-final_xgb %>% 
    fit(testing(dat_split)) %>% 
    predict(new_data = aspen.pts.df[aspen.pts.df$cut==j, ], type="prob")
  aspen.pts.df[aspen.pts.df$cut==j, ]$predicted <- all_prediction$`.pred_1`
  print(j)
}

aspen90.pred <- aspen90.prob01
aspen90.pred.cells <- cells(aspen90.pred)
aspen90.pred[!aspen90.pred.cells] <-  -9999
aspen90.pred.bak <- aspen90.pred

aspen90.pred <- aspen90.prob01
aspen90.pred[aspen.pts.df$cell] <-  aspen.pts.df$predicted
writeRaster(aspen90.pred, here("Data", "Spatial", "predicted_1981-2010-xgb.tif"),overwrite=T)

aspen90.pred[aspen90.pred>=0.5] <- 1
aspen90.pred[aspen90.pred<0.5] <- 0
aspen90.preds.dif <- aspen90.prob01
aspen90.preds.dif[aspen90.preds.dif==1] <- 10
aspen90.preds.dif <- aspen90.preds.dif - aspen90.pred
aspen90.preds.dif[aspen90.preds.dif==-1] <- 2 # false positive
aspen90.preds.dif[aspen90.preds.dif==9] <- 1 # correct
aspen90.preds.dif[aspen90.preds.dif==10] <- -1 # false negative


writeRaster(aspen90.preds.dif, here("Data", "Spatial", "predicted_1981-2010-xgb-classerror.tif"),overwrite=T)

plot(aspen90.preds.dif, col=c("#4d4d4d", "gray", "#d53e4f", "#3288bd"))

# Predict
yearz <- c("2011_2040", "2041_2070", "2071_2100")
for(years in yearz){
  climate90 <- rast(paste0(here("Data", "Spatial", "Downscaled"), "/ensemble_8GCMs_ssp370_", years, "_90.tif"))
  # Compile data
  aspen.pts <- aspen90.prob01 %>% as.points(na.rm=T)
  aspen.pts <- terra::extract(aspen90.prob,aspen.pts, bind=T, xy=T, cells=T) 
  aspen.pts <- extract(climate90, aspen.pts, bind=T)
  aspen.pts <- extract(topo90, aspen.pts, bind=T)
  aspen.pts <- extract(soil90, aspen.pts, bind=T)
  
  # predict on entire dataset in five separate chunks
  aspen.pts.df <- aspen.pts %>% as.data.frame() %>% na.omit()
  aspen.pts.df$cut <- cut(1:nrow(aspen.pts.df), breaks=5)
  aspen.pts.df$predicted <- NA
  for(j in unique(aspen.pts.df$cut)){
    all_prediction <-final_xgb %>% 
      fit(testing(dat_split)) %>% 
      predict(new_data = aspen.pts.df[aspen.pts.df$cut==j, ], type="prob")
    aspen.pts.df[aspen.pts.df$cut==j, ]$predicted <- all_prediction$`.pred_1`
    print(j)
  }
  
  aspen90.pred <- aspen90.prob01
  aspen90.pred.cells <- cells(aspen90.pred)
  aspen90.pred[!aspen90.pred.cells] <-  -9999
  aspen90.pred.bak <- aspen90.pred
  
  aspen90.pred <- aspen90.prob01
  aspen90.pred[aspen.pts.df$cell] <-  aspen.pts.df$predicted
  writeRaster(aspen90.pred, paste0(here("Data", "Spatial"), "/predicted_", years, "-xgb.tif"),overwrite=T)

}


```

#### Random Forest

```{r}
# Specify model
rf_spec <- 
  rand_forest(
    trees=1000,
    min_n=tune(),
    mtry=tune()
  ) %>%
  set_engine("ranger", importance = "permutation") %>% 
  set_mode("classification")

# Create workflow
rf_wflow <- 
  workflow() %>% 
  add_recipe(presence.recipe) %>% 
  add_model(rf_spec)

# Tune model
### Set parameters to be tuned
rf_params <- 
  dials::parameters(
    finalize(mtry(),select(aspen.sample.pts,all_of(pred.vars))),
    min_n()
)

## Create grid of search values
rf_grid <- 
  dials::grid_latin_hypercube(
    rf_params, 
    size = 50
)

### Perform tuning
rf_tuned <- tune::tune_grid(
  object = rf_wflow,
  resamples = cv_folds,
  grid = rf_grid,
  metrics = metric_set(recall, precision, f_meas, accuracy, kap, roc_auc, sens, spec),
  control = tune::control_grid(verbose = TRUE)
)

# Finalize workflow
rf_best_params <- rf_tuned %>% tune::select_best("roc_auc")
final_rf <- rf_wflow %>% finalize_workflow(rf_best_params)

# Evaluate model on training dataset
rf_res <- 
  final_rf %>% 
  fit_resamples(
    resamples = cv_folds, 
    metrics = metric_set(recall, precision, f_meas, accuracy, kap, roc_auc, sens, spec),
    control = control_resamples(save_pred = TRUE)
    ) 

rf_res %>%  collect_metrics(summarize = TRUE) %>% mutate(Dataset="Calibration") %>% mutate(Model="RF") %>% write.csv(here("Results", "RF-calibration-stats.csv"))

# Evaluate model on testing dataset
rf_last_fit <- last_fit(final_rf,
                         split=dat_split,
                         metrics = metric_set(recall, precision, f_meas, accuracy, kap,roc_auc, sens, spec))

rf_last_fit %>% collect_metrics() %>% mutate(Dataset="Validation", Model="RF") %>% write.csv(here("Results", "RF-validation-stats.csv"))

# Variable importance
vi <- rf_last_fit %>% 
  pluck(".workflow", 1) %>%   
  extract_fit_parsnip() %>% 
  vip()
write.csv(vi$data %>% mutate(Model="XGB"), here("Results", "vip-rf.csv"))

# Partial dependence and accumualted local effects
explainer_rf<- explain_tidymodels(final_rf %>% fit(training(dat_split)), 
                                    data=training(dat_split) %>% as.data.frame() %>% select(-aspen.presence), 
                                    y=training(dat_split) %>% pull(aspen.presence) %>% as.numeric(),
                                    type="classification", verbose=F
)

pdp <- model_profile(explainer_rf , N = 500, variables = pred.vars, type="partial")
pdp$agr_profiles %>% mutate(method="PDP", Model="RF") %>% write.csv(here("Results", "pdp-XGB.csv"))
ale <- model_profile(explainer_rf , N = 500, variables = pred.vars, type="accumulated")
ale$agr_profiles %>% mutate(method="ALE", Model="RF")  %>% write.csv(here("Results", "ale-XGB.csv"))

# predict on entire dataset in five separate chunks
aspen.pts.df <- aspen.pts %>% as.data.frame() %>% na.omit()
aspen.pts.df$cut <- cut(1:nrow(aspen.pts.df), breaks=5)
aspen.pts.df$predicted <- NA
for(j in unique(aspen.pts.df$cut)){
  all_prediction <-final_rf %>% 
    fit(testing(dat_split)) %>% 
    predict(new_data = aspen.pts.df[aspen.pts.df$cut==j, ], type="prob")
  aspen.pts.df[aspen.pts.df$cut==j, ]$predicted <- all_prediction$`.pred_1`
  print(j)
}

aspen90.pred <- aspen90.prob01
aspen90.pred.cells <- cells(aspen90.pred)
aspen90.pred[!aspen90.pred.cells] <-  -9999
aspen90.pred.bak <- aspen90.pred

aspen90.pred <- aspen90.prob01
aspen90.pred[aspen.pts.df$cell] <-  aspen.pts.df$predicted
writeRaster(aspen90.pred, here("Data", "Spatial", "predicted_1981-2010-rf.tif"),overwrite=T)

aspen90.pred[aspen90.pred>=0.5] <- 1
aspen90.pred[aspen90.pred<0.5] <- 0
aspen90.preds.dif <- aspen90.prob01
aspen90.preds.dif[aspen90.preds.dif==1] <- 10
aspen90.preds.dif <- aspen90.preds.dif - aspen90.pred
aspen90.preds.dif[aspen90.preds.dif==-1] <- 2 # false positive
aspen90.preds.dif[aspen90.preds.dif==9] <- 1 # correct
aspen90.preds.dif[aspen90.preds.dif==10] <- -1 # false negative
writeRaster(aspen90.preds.dif, here("Data", "Spatial", "predicted_1981-2010-rf-classerror.tif"),overwrite=T)

plot(aspen90.preds.dif, col=c("#4d4d4d", "gray", "#d53e4f", "#3288bd"))

# Predict
yearz <- c("2011_2040", "2041_2070", "2071_2100")
for(years in yearz){
  climate90 <- rast(paste0(here("Data", "Spatial", "Downscaled"), "/ensemble_8GCMs_ssp370_", years, "_90.tif"))
  # Compile data
  aspen.pts <- aspen90.prob01 %>% as.points(na.rm=T)
  aspen.pts <- terra::extract(aspen90.prob,aspen.pts, bind=T, xy=T, cells=T) 
  aspen.pts <- extract(climate90, aspen.pts, bind=T)
  aspen.pts <- extract(topo90, aspen.pts, bind=T)
  aspen.pts <- extract(soil90, aspen.pts, bind=T)
  
  # predict on entire dataset in five separate chunks
  aspen.pts.df <- aspen.pts %>% as.data.frame() %>% na.omit()
  aspen.pts.df$cut <- cut(1:nrow(aspen.pts.df), breaks=5)
  aspen.pts.df$predicted <- NA
  for(j in unique(aspen.pts.df$cut)){
    all_prediction <-final_rf %>% 
      fit(testing(dat_split)) %>% 
      predict(new_data = aspen.pts.df[aspen.pts.df$cut==j, ], type="prob")
    aspen.pts.df[aspen.pts.df$cut==j, ]$predicted <- all_prediction$`.pred_1`
    print(j)
  }
  
  aspen90.pred <- aspen90.prob01
  aspen90.pred.cells <- cells(aspen90.pred)
  aspen90.pred[!aspen90.pred.cells] <-  -9999
  aspen90.pred.bak <- aspen90.pred
  
  aspen90.pred <- aspen90.prob01
  aspen90.pred[aspen.pts.df$cell] <-  aspen.pts.df$predicted
  writeRaster(aspen90.pred, paste0(here("Data", "Spatial"), "/predicted_", years, "-rf.tif"),overwrite=T)

}


```

#### Ensemble

```{r}
weights.glmnet <- read.csv(here("Results", "GLMNET-validation-stats.csv")) %>% filter(.metric=="roc_auc") %>% select(`.estimate`)
weights.rf <- read.csv(here("Results", "RF-validation-stats.csv")) %>% filter(.metric=="roc_auc") %>% select(`.estimate`)
weights.xgb <- read.csv(here("Results", "XGB-validation-stats.csv")) %>% filter(.metric=="roc_auc") %>% select(`.estimate`)

weights <- weights.glmnet + weights.rf + weights.xgb
weights.glmnet <- weights.glmnet/weights
weights.rf <- weights.rf/weights
weights.xgb <- weights.rf/weights

weightj <- list(weights.glmnet, weights.rf , weights.xgb )
names(weightj) <- c("GLMNET", "RF", "XGB")
for(k in yearz <- c("1981_2010", "2011_2040", "2041_2070", "2071_2100")){
   stackk<- NULL
   for(j in c("GLMNET", "RF", "XGB")){
    stackk <- c(stackk, rast(paste0(here("Data", "Spatial"), "/predicted_", k, "-", j , ".tif"))* weightj[[j]]$.estimate)
   }
   stackj <- (stackk[[1]] +stackk[[2]]+stackk[[3]])/3
   writeRaster(stackj, paste0(here("Data", "Spatial"), "/predicted_ensemble_", k, ".tif"))
}

# assess accuracy
pred <- rast(here("Data", "Spatial", "predicted_ensemble_1981_2010.tif"))
pred[pred>=0.5] <-1
pred[pred<0.5] <-0

ensemble.stats <- data.frame(.metric=c("accuracy", "f_meas", "kap", "precision", "recall", "roc_auc", "sens", "spec"), .estimator="binary", mean=NA)
true <- testing(dat_split) %>% as.data.frame()
coordinates(true) <- ~x+y
crs(true) <- crs(aspen90.prob )
true <- true %>% vect()
predictor <- extract(pred, true) 
 ensemble.stats[ensemble.stats$`.metric`=="roc_auc",]$mean <- roc(response =true$aspen.presence , predictor=predictor$aspen.presence) %>% auc() %>% as.vector()
  x <- table(predictor$aspen.presence, true$aspen.presence) %>% confusionMatrix(mode = "everything", positive="1")
  ensemble.stats[ensemble.stats$`.metric`=="accuracy",]$mean <- x$overall['Accuracy']
  ensemble.stats[ensemble.stats$`.metric`=="kap",]$mean <- x$overall['Kappa']
  ensemble.stats[ensemble.stats$`.metric`=="precision",]$mean <- x$byClass['Precision']
  ensemble.stats[ensemble.stats$`.metric`=="recall",]$mean <- x$byClass['Recall']
  ensemble.stats[ensemble.stats$`.metric`=="sens",]$mean <- x$byClass['Sensitivity']
  ensemble.stats[ensemble.stats$`.metric`=="spec",]$mean <- x$byClass['Specificity']
  ensemble.stats[ensemble.stats$`.metric`=="f_meas",]$mean <- x$byClass['F1']

write.csv(ensemble.stats, here("Results","Ensemble-validation-stats.csv"))
```

### Characterize patterns

```{r}
aspen90.prob <- rast(here("Data", "Spatial", "Aspen",  "srme_skcv_distribution_binopt-90.tif"))
names(aspen90.prob) <- "aspen.prob"
aspen90.prob01 <- aspen90.prob
aspen90.prob01[aspen90.prob01>0]<-1

pred.1981_2010 <- rast(here("Data", "Spatial", "predicted_ensemble_1981_2010.tif"))
pred.2011_2040 <- rast(here("Data", "Spatial", "predicted_ensemble_2011_2040.tif"))
pred.2041_2070 <- rast(here("Data", "Spatial", "predicted_ensemble_2041_2070.tif"))
pred.2071_2100 <- rast(here("Data", "Spatial", "predicted_ensemble_2071_2100.tif"))


pred.1981_2010[pred.1981_2010>=0.5] <- 1
pred.1981_2010[pred.1981_2010<0.5] <- 0
aspen90.preds.dif <- aspen90.prob01
aspen90.preds.dif[aspen90.preds.dif==1] <- 10
aspen90.preds.dif <- aspen90.preds.dif - pred.1981_2010
aspen90.preds.dif[aspen90.preds.dif==-1] <- 2 # false positive
aspen90.preds.dif[aspen90.preds.dif==9] <- 1 # correct
aspen90.preds.dif[aspen90.preds.dif==10] <- -1 # false negative
writeRaster(aspen90.preds.dif, here("Data", "Spatial", "predicted_1981-2010-ensemble-classerror.tif"),overwrite=T)

pred.2011_2040[pred.2011_2040>=0.5] <- 1
pred.2011_2040[pred.2011_2040<0.5] <- 0

change <- pred.1981_2010
change[change==1] <- 10
change <- change- pred.2011_2040
change[change==-1] <- 2 # gain
change[change==10] <- -1 # loss
change[change==9] <- 1 # stable
writeRaster(change, here("Data", "Spatial", "change_2011-2040-ensemble.tif"), overwrite=T)

pred.2041_2070[pred.2041_2070>=0.5] <- 1
pred.2041_2070[pred.2041_2070<0.5] <- 0

change <- pred.1981_2010
change[change==1] <- 10
change <- change- pred.2041_2070
change[change==-1] <- 2 # gain
change[change==10] <- -1 # loss
change[change==9] <- 1 # stable
writeRaster(change, here("Data", "Spatial", "change_2041-2070-ensemble.tif"), overwrite=T)


pred.2071_2100[pred.2071_2100>=0.5] <- 1
pred.2071_2100[pred.2071_2100<0.5] <- 0

change <- pred.1981_2010
change[change==1] <- 10
change <- change- pred.2071_2100
change[change==-1] <- 2 # gain
change[change==10] <- -1 # loss
change[change==9] <- 1 # stable
writeRaster(change, here("Data", "Spatial", "change_2071-2100-ensemble.tif"), overwrite=T)

change2011.2040 <- rast(here("Data", "Spatial", "change_2011-2040-ensemble.tif"))
change2041.2070 <- rast(here("Data", "Spatial", "change_2041-2070-ensemble.tif"))
change2071.2100 <- rast(here("Data", "Spatial", "change_2071-2100-ensemble.tif"))


change2011.2040.f <- freq(change2011.2040) %>% mutate(year="2011-2040")
change2041.2070.f <- freq(change2041.2070) %>% mutate(year="2041-2070")
change2071.2100.f <- freq(change2071.2100) %>% mutate(year="2071-2100")
change.f <- do.call(rbind, list(change2011.2040.f, change2041.2070.f, change2071.2100.f)) %>% filter(!value==0)
change.f$var <- factor(change.f$value, levels=c(-1,1,2),labels=c("loss", "stable", "gain"))
change.f$area <- change.f$count*90*90*10^-6
ggplot(change.f, aes(x=year, y=area,fill=var))+geom_bar(stat="identity", position="dodge")+theme(legend.title=element_blank())+ylab("area (sq. km)")+scale_fill_manual(values=c("#d95f02", "#1b9e77", "#7570b3"))

area.1981.2010 <- freq(pred.1981_2010) %>% filter(value==1) %>% pull(count)
area.2011.2040 <- freq(pred.2011_2040) %>% filter(value==1) %>% pull(count)
area.2041.2070 <- freq(pred.2041_2070) %>% filter(value==1) %>% pull(count)
area.2071.2100 <- freq(pred.2071_2100) %>% filter(value==1) %>% pull(count)
area.df <- data.frame( year=c("1985-2010","2011-2040", "2041-2070", "2071-2100"), area=c(area.1981.2010, area.2011.2040, area.2041.2070, area.2071.2100))
area.df$area <- 90*90 * area.df$area *10^-6
ggplot(area.df, aes(x=year, y=area))+geom_point()+ylab("area (sq. km)")

```

# Results

```{r}



```

# Discussion

# References

::: {#refs}
:::

\newpage

# Supplemental Analyses

## Screening predictor variables

```{r Screen_Climate_Vars}
# Import response variable
aspen90.prob <- rast(here("Data", "Spatial", "Aspen",  "srme_skcv_distribution_binopt-90.tif"))
names(aspen90.prob) <- "aspen.prob"
aspen90.prob01 <- aspen90.prob
aspen90.prob01[aspen90.prob01<0.5]<-0
aspen90.prob01[aspen90.prob01>=0.5]<-1
names(aspen90.prob01) <- "aspen.presence"

SRM <- st_read(here("Data", "Spatial", "Ecoregions", "us_eco_l3.shp")) %>% filter(US_L3NAME == 'Southern Rockies') %>% st_transform(crs(aspen90.prob))
aspen90.prob <- terra::mask(aspen90.prob, SRM)
aspen90.prob01 <-terra::mask(aspen90.prob01, SRM)

# Import predictor variables

topo90 <- rast(here("Data", "Spatial", "DEM", "Topo90.tif"))
soil90 <- rast(here("Data", "Spatial", "Soils", "Soils90.tif"))

climate.dat.1981_2010 <- rast(list.files(here("Data", "Spatial", "Climate", "ClimateNA", "Normal_1981_2010", "Normal_1981_2010_bioclim"), pattern=".tif$", full.names = T))
names(climate.dat.1981_2010) <- sapply(strsplit(do.call(c,strsplit(list.files(here("Data", "Spatial", "Climate", "ClimateNA", "Normal_1981_2010", "Normal_1981_2010_bioclim"), pattern=".tif$", full.names = F), split=".tif")), split="Normal_1981_2010_"), "[", 2)

climate.dat2.1981_2010 <- rast(list.files(here("Data", "Spatial", "Climate", "ClimateNA", "Derived"), pattern="Normal", full.names = T))
names(climate.dat2.1981_2010) <- sapply(strsplit(do.call(c,strsplit(list.files(here("Data", "Spatial", "Climate", "ClimateNA", "Derived"), pattern="Normal", full.names = F), split=".tif")), split="Normal_1981_2010_"), "[",2)


# Compile data
aspen.pts <- aspen90.prob01 %>% as.points(na.rm=T)
aspen.pts <- aspen.pts[sample(1:nrow(aspen.pts), size=10000),]
aspen.pts <- terra::extract(aspen90.prob,aspen.pts, bind=T, xy=T, cells=T) 
aspen.pts <- extract(topo90, aspen.pts, bind=T)
aspen.pts <- extract(soil90, aspen.pts, bind=T)
aspen.pts <- aspen.pts %>% terra::project(climate.dat.1981_2010 )

aspen.pts.1981_2010 <- aspen.pts
aspen.pts.1981_2010<- extract(climate.dat.1981_2010, aspen.pts.1981_2010, bind=T)
aspen.pts.1981_2010 <- extract(climate.dat2.1981_2010, aspen.pts.1981_2010, bind=T)
aspen.pts.1981_2010$year <- "1981-2010"


dat <- aspen.pts.1981_2010  %>% as.data.frame() %>% na.omit()
dat.2011_2040 <- aspen.pts.2011_2040  %>% as.data.frame() %>% na.omit()
dat.2041_2070 <- aspen.pts.2041_2070 %>% as.data.frame() %>% na.omit()
dat.2071_2100 <- aspen.pts.2071_2100  %>% as.data.frame() %>% na.omit()

climate.varz <- c("TMAX","ADI","TD","PRATIO","FFP","GSPDD5","Tave_wt","bFFP","CMD","CMI","DD_0","DD_18","DD1040","DD18","DD5","eFFP","EMT","Eref","EXT","GSP","MAP","MAR","MAT","MCMT","MSP","MWMT","NFFD","PAS","PPT_at","PPT_sm","PPT_sp","PPT_wt","RH","SHM","Tave_at","Tave_sm","Tave_sp")

dat[,c(climate.varz,"year")] %>% filter(year=="1981-2010") %>% select(-year) %>% cor() %>% round(digits=2) %>% write.csv(here("Results", "climate-var-cor.csv"))

dat.dif <- dat[,c(climate.varz ,"year", "aspen.presence")]  
dat.dif[,c(climate.varz )] <- dat.dif[,c(climate.varz)] %>% scale()
dat.dif <- dat.dif %>% group_by(year, aspen.presence) %>% summarise(across(everything(),mean), .groups = 'drop') %>% as.data.frame() %>% filter(year=="1981-2010") %>% select(-year,-aspen.presence)
dat.dif <- (dat.dif[1,]- dat.dif[2,]) %>% t() %>% as.data.frame()
dat.dif$abs <- abs(dat.dif[,1] )

dat.dif[order(dat.dif$abs, decreasing = T),]
dat.dif$var <- row.names(dat.dif)

results <- data.frame(var=climate.varz, AUC=NA)
for(j in climate.varz){
  modj <- rf(data=dat, dependent.variable.name ="aspen.presence", predictor.variable.names =j, n.cores=cores-1,ranger.arguments = list(num.trees=500, mtry=1, min.node.size=100), verbose=F)
  rf.mod.pred <- ifelse(predict(modj, data=dat, type="response")$predictions>0.5,1,0)
  datj <- data.frame(observed=dat$aspen.presence, predicted=rf.mod.pred)
  results[results$var==j, "AUC"] <- datj %>% roc("predicted", "observed") %>% auc
  modj <- NULL
}

results <- left_join(results, dat.dif[,c("var", "abs")], by="var")
results <-results[order(results$AUC, decreasing=T),]
write.csv(results, here("Results", "bivariate-RF-AUC.csv"),row.names=F)

c("ADI",  "PRATIO", "GSPDD5", "GSP", "MCMT", "PPT_sm", "TD","RH", "MAR")


```

+------------+---------------------------------------------------+---------------------------------------+---------------------------------------------------------------------------------------------------------------+
| Variable   | Description                                       | Trend                                 | Modeling notes                                                                                                |
+============+===================================================+=======================================+===============================================================================================================+
| ADI        | annual dryness index:                             | increasing; less favorable for aspen  | retain, highest AUC in bivariate RF model; identified by @rehfeldt2009 as an important predictor              |
|            |                                                   |                                       |                                                                                                               |
|            | $\frac{MAT+10}{(MAP/1000)}$                       |                                       |                                                                                                               |
+------------+---------------------------------------------------+---------------------------------------+---------------------------------------------------------------------------------------------------------------+
| **GSPDD5** | $\frac{GSP*DD5}{1000}$                            | decreasing; less favorable for aspen? | retain, third highest AUC in bivariate RF model; identified by @rehfeldt2009 as an important predictor        |
+------------+---------------------------------------------------+---------------------------------------+---------------------------------------------------------------------------------------------------------------+
| FFP        | length of the frost-free period                   | increasing; less favorable for aspen  | remove, strongly correlated with MCMT; identified by @rehfeldt2009 as an important predictor                  |
+------------+---------------------------------------------------+---------------------------------------+---------------------------------------------------------------------------------------------------------------+
| **PRATIO** | $\frac{GSP}{MAP}$                                 | relatively stable; no effect on aspen | retain, second highest AUC in bivariate RF model; identified by @rehfeldt2009 as an important predictor       |
+------------+---------------------------------------------------+---------------------------------------+---------------------------------------------------------------------------------------------------------------+
| TD         | difference between MCMT and MWMT                  |                                       | retain, identified by as an important predictor by @rehfeldt2015                                              |
+------------+---------------------------------------------------+---------------------------------------+---------------------------------------------------------------------------------------------------------------+
| TMAX       | maximum temperature of the warmest month          | increasing                            | remove, highly correlated with ADI; identified by as an important predictor by @rehfeldt2015                  |
+------------+---------------------------------------------------+---------------------------------------+---------------------------------------------------------------------------------------------------------------+
| bFFP       | julian date on which the frost free period beings | decreasing                            | remove, strongly correlated with MCMT                                                                         |
+------------+---------------------------------------------------+---------------------------------------+---------------------------------------------------------------------------------------------------------------+
| CMD        | Hargreave's moisture index                        | increasing                            | remove, highly correlated with ADI                                                                            |
+------------+---------------------------------------------------+---------------------------------------+---------------------------------------------------------------------------------------------------------------+
| CMI        | Hogg's climate moisture index                     | decreasing                            | remove, highly correlated with ADI                                                                            |
+------------+---------------------------------------------------+---------------------------------------+---------------------------------------------------------------------------------------------------------------+
| DD_0       | degree-days below 0 C                             | decreasing                            | remove, highly correlated with GSPDD5                                                                         |
+------------+---------------------------------------------------+---------------------------------------+---------------------------------------------------------------------------------------------------------------+
| **DD_18**  | degree-days below 18 C                            | decreasing                            | remove, highly correlated with ADI                                                                            |
+------------+---------------------------------------------------+---------------------------------------+---------------------------------------------------------------------------------------------------------------+
| DD1040     | degrees-days above 10 C and below 40 C            | increasing                            | remove, highly correlated with ADI                                                                            |
+------------+---------------------------------------------------+---------------------------------------+---------------------------------------------------------------------------------------------------------------+
| **DD18**   | degree-days above 18 C                            | increasing                            | remove, strongly correlated with MCMT                                                                         |
+------------+---------------------------------------------------+---------------------------------------+---------------------------------------------------------------------------------------------------------------+
| DD5        | degree-days above 5 C                             | increasing                            | remove, highly correlated with ADI                                                                            |
+------------+---------------------------------------------------+---------------------------------------+---------------------------------------------------------------------------------------------------------------+
| eFFP       | julian date on which the frost free period ends   | increasing                            | remove, strongly correlated with MCMT                                                                         |
+------------+---------------------------------------------------+---------------------------------------+---------------------------------------------------------------------------------------------------------------+
| EMT        | extreme minimum temperature                       | increasing                            | remove, strongly correlated with MCMT                                                                         |
+------------+---------------------------------------------------+---------------------------------------+---------------------------------------------------------------------------------------------------------------+
| Eref       | Hargreave's reference evapotranspiration          | increasing                            | remove, highly correlated with ADI                                                                            |
+------------+---------------------------------------------------+---------------------------------------+---------------------------------------------------------------------------------------------------------------+
| EXT        | extreme maximum temperature                       | increasing                            | remove, highly correlated with ADI                                                                            |
+------------+---------------------------------------------------+---------------------------------------+---------------------------------------------------------------------------------------------------------------+
| GSP        | growing season (Apr - Sep) precipitation          | slight decrease                       | retain, not strongly correlated with ADI, PRATIO, or GSPDD5 (and better performance in bivariate RF than MSP) |
+------------+---------------------------------------------------+---------------------------------------+---------------------------------------------------------------------------------------------------------------+
| MAP        | mean annual precipitation                         | no change                             | remove, highly correlated with ADI                                                                            |
+------------+---------------------------------------------------+---------------------------------------+---------------------------------------------------------------------------------------------------------------+
| **MAR**    | mean annual solar radiation                       | increase                              | retain, not strongly correlated with any variables                                                            |
+------------+---------------------------------------------------+---------------------------------------+---------------------------------------------------------------------------------------------------------------+
| MAT        | mean annual temperature                           | increase                              | remove, highly correlated with ADI                                                                            |
+------------+---------------------------------------------------+---------------------------------------+---------------------------------------------------------------------------------------------------------------+
| MCMT       | mean temperature of the coldest month             | increase                              | retain, not strongly correlated with ADI, PRATIO, or GSPDD5 (and better performance in bivariate RF than FFP) |
+------------+---------------------------------------------------+---------------------------------------+---------------------------------------------------------------------------------------------------------------+
| MSP        | mean summer (May - Sept) precipitation            | slight decrease                       | remove, highly correlated with GSP                                                                            |
+------------+---------------------------------------------------+---------------------------------------+---------------------------------------------------------------------------------------------------------------+
| MWMT       | mean temperature of the warmest month             | increase                              | remove, highly correlated with ADI                                                                            |
+------------+---------------------------------------------------+---------------------------------------+---------------------------------------------------------------------------------------------------------------+
| NFFD       | the number of frost free days                     | increase                              | remove, strongly correlated with MCMT                                                                         |
+------------+---------------------------------------------------+---------------------------------------+---------------------------------------------------------------------------------------------------------------+
| PAS        | precipitation as snow                             | slight decrease                       | remove, highly correlated with ADI                                                                            |
+------------+---------------------------------------------------+---------------------------------------+---------------------------------------------------------------------------------------------------------------+
| PPT_at     | autumn precipitation                              | no change                             | remove, highly correlated with ADI                                                                            |
+------------+---------------------------------------------------+---------------------------------------+---------------------------------------------------------------------------------------------------------------+
| **PPT_sm** | summer precipitation                              | no change                             | retain                                                                                                        |
+------------+---------------------------------------------------+---------------------------------------+---------------------------------------------------------------------------------------------------------------+
| **PPT_sp** | spring precipitation                              | no change                             | remove, highly correlated with ADI                                                                            |
+------------+---------------------------------------------------+---------------------------------------+---------------------------------------------------------------------------------------------------------------+
| PPT_wt     | winter precipitation                              | no change                             | remove, highly correlated with ADI                                                                            |
+------------+---------------------------------------------------+---------------------------------------+---------------------------------------------------------------------------------------------------------------+
| **RH**     | relative humidity                                 | no change                             | retain, not highly correlated with any other climate variables                                                |
+------------+---------------------------------------------------+---------------------------------------+---------------------------------------------------------------------------------------------------------------+
| SHM        | summer heat moisture index:                       | increase                              | remove, highly correlated with ADI                                                                            |
|            |                                                   |                                       |                                                                                                               |
|            | $\frac{MWMT}{MSP/1000}$                           |                                       |                                                                                                               |
+------------+---------------------------------------------------+---------------------------------------+---------------------------------------------------------------------------------------------------------------+
| Tave_at    | mean autumn temperature                           | increase                              | remove, highly correlated with ADI                                                                            |
+------------+---------------------------------------------------+---------------------------------------+---------------------------------------------------------------------------------------------------------------+
| Tave_sm    | mean summer temperature                           | increase                              | remove, highly correlated with ADI                                                                            |
+------------+---------------------------------------------------+---------------------------------------+---------------------------------------------------------------------------------------------------------------+
| Tave_sp    | mean spring temperature                           | increase                              | remove, highly correlated with ADI                                                                            |
+------------+---------------------------------------------------+---------------------------------------+---------------------------------------------------------------------------------------------------------------+
| Tave_wt    | mean winter temperature                           | increase                              | remove, highly correlated with MCMT                                                                           |
+------------+---------------------------------------------------+---------------------------------------+---------------------------------------------------------------------------------------------------------------+

```{r}

```

## Modeling building approach

```{r}

# PRES/AB MODEL
mod01 <- rf(data=dat.train, dependent.variable.name ="aspen.presence", predictor.variable.names =pred.vars, xy=xydat, distance.thresholds = distthresh, n.cores=cores-1)

mod01.train <- rf_tuning(model=mod01,repetitions = 30, num.trees = c(500), mtry = c(3,5), min.node.size = c(50,100))

mod01.final <- rf(data=dat.train, dependent.variable.name ="aspen.presence", predictor.variable.names =pred.vars, xy=xydat, distance.thresholds = distthresh, n.cores=cores-1, ranger.arguments = list(num.trees=mod01.train$num.trees, mtry=mod01.train$mtry, min.node.size=mod01.train$min.node.size))

mod01.pred <- predict(mod.freq.final , data=dat.test, type="response")
mod01.pred <- ifelse(mod01.pred$predictions>0.5,1,0) %>% as.factor()
confusionMatrix(data = mod01.pred, reference = dat.train$aspen.presence %>% as.factor())

# FREQ MODEL
dat.train.sub <- dat.train[dat.train$aspen.presence==1,]
xydat <-dat.train.sub[,c("x","y")]
distdat <- dist(xydat, method = "euclidean", diag=T, upper=T) 

mod.freq <- rf(data=dat.train.sub, dependent.variable.name ="aspen.prob", predictor.variable.names =pred.vars, xy=xydat, distance.thresholds = , n.cores=cores-1)

mod.freq.train <- rf_tuning(model=mod.freq,repetitions = 30, num.trees = c(100,500), mtry = c(3,5), min.node.size = c(50,100))

mod.freq.final <- rf(data=dat.train.sub, dependent.variable.name ="aspen.prob", predictor.variable.names =pred.vars, xy=xydat, distance.thresholds = , n.cores=cores-1, ranger.arguments = list(num.trees=mod.freq.train$num.trees, mtry=mod.freq.train$mtry, min.node.size=mod.freq.train$min.node.size))

mod.freq.pred <- predict(mod.freq, data=dat.test, type="response")

postResample(mod.freq.pred$predictions*as.numeric(mod01.pred), dat.test$aspen.prob)

```
